---
title: "Script d'exploitation"
author: "Paul Crespin"
date: "2024-07-02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
resultats_teneur_en_proteines <- read_excel("C:/Users/Pol/Downloads/résultats teneur en protéines.xlsx")
resultats_teneur_en_proteines <- read_excel("C:/Users/Paul/Downloads/resultats teneur en proteines.xlsx")
prot_2022 <- as.numeric(as.vector(unlist(resultats_teneur_en_proteines[22:199, 2])))
prot_2023 <- as.numeric(as.vector(unlist(resultats_teneur_en_proteines[22:51, 6])))
```

# Uniformisation des données / Extraction.

```{r}
donnee <- c()
# ech <- c(1:44, 46:178) # VIAVI MicroNIRS manquant
ech <- c(1:178)
# ech <- c(1:25)

labo <- c()
list_ech <- c()
spectrom <- c()
list_annee <- c()
list_prot <- c()

for (ech_voulu in ech) {
  for (lab in 1:length(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]])) {
    for (spectro in 1:length(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]])) {
      for (mesure in 1:length(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]])) {
        if (Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[1]][[6]] == "Ref") {
          if (Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[1]][[5]] == "nm") {
            if (Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][1] < Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][2]) {
              donnee <- c(donnee, data.frame(V1 = Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]], V2 = - log(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]], 10)))
            } else {
              donnee <- c(donnee, data.frame(V1 = Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][seq(length(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]])[1], 1)], V2 = - log(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]][seq(length(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]])[1], 1)], 10)))
            }
          } else {
            if (Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][1] > Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][2]) {
              donnee <- c(donnee, data.frame(V1 = 1 / Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]] * 10000000, V2 = - log(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]], 10)))
            } else {
              donnee <- c(donnee, data.frame(V1 = 1 / Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][seq(length(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]])[1], 1)] * 10000000, V2 = - log(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]][seq(length(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]])[1], 1)], 10)))
            }
          }
        } else {
          if (Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[1]][[5]] == "nm") {
            if (Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][1] < Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][2]) {
              donnee <- c(donnee, Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]])
            } else {
              donnee <- c(donnee, Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][seq(dim(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]])[1], 1),])
            }
          } else {
            if (Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][1] > Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][2]) {
              donnee <- c(donnee, data.frame(V1 = 1 / Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]] * 10000000, V2 = Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]]))
            } else {
              donnee <- c(donnee, data.frame(V1 = 1 / Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][seq(length(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]])[1], 1)] * 10000000, V2 = Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]][seq(length(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]])[1], 1)]))
            }
          }
        }
        labo <- c(labo, names(Base_De_Donnees_Spectres$Annee2022$BGE1)[lab])
        list_ech <- c(list_ech, names(Base_De_Donnees_Spectres$Annee2022)[ech_voulu])
        spectrom <- c(spectrom, names(Base_De_Donnees_Spectres$Annee2022[[ech_voulu]][[lab]])[spectro])
        list_annee <- c(list_annee, 2022)
        list_prot <- c(list_prot, prot_2022[ech_voulu])
      }
    }
  }
}

ech <- c(1:15, 17:30) # ECOSYS_Palaiseau
# ech <- c(1:30)

for (ech_voulu in ech) {
  for (lab in 1:length(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]])) {
    for (spectro in 1:length(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]])) {
      for (mesure in 1:length(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]])) {
        if (Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[1]][[6]] == "Ref") {
          if (Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[1]][[5]] == "nm") {
            if (Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][1] < Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][2]) {
              donnee <- c(donnee, data.frame(V1 = Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]], V2 = - log(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]], 10)))
            } else {
              donnee <- c(donnee, data.frame(V1 = Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][seq(length(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]])[1], 1)], V2 = - log(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]][seq(length(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]])[1], 1)], 10)))
            }
          } else {
            if (Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][1] > Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][2]) {
              donnee <- c(donnee, data.frame(V1 = 1 / Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]] * 10000000, V2 = - log(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]], 10)))
            } else {
              donnee <- c(donnee, data.frame(V1 = 1 / Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][seq(length(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]])[1], 1)] * 10000000, V2 = - log(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]][seq(length(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]])[1], 1)], 10)))
            }
          }
        } else {
          if (Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[1]][[5]] == "nm") {
            if (Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][1] < Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][2]) {
              donnee <- c(donnee, Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]])
            } else {
              donnee <- c(donnee, Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][seq(dim(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]])[1], 1),])
            }
          } else {
            if (Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][1] > Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][2]) {
              donnee <- c(donnee, data.frame(V1 = 1 / Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]] * 10000000, V2 = Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]]))
            } else {
              donnee <- c(donnee, data.frame(V1 = 1 / Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]][seq(length(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[1]])[1], 1)] * 10000000, V2 = Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]][seq(length(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]][[spectro]][[mesure]][[2]][[2]])[1], 1)]))
            }
          }
        }
        labo <- c(labo, names(Base_De_Donnees_Spectres$Annee2023$BGE7)[lab])
        list_ech <- c(list_ech, names(Base_De_Donnees_Spectres$Annee2023)[ech_voulu])
        spectrom <- c(spectrom, names(Base_De_Donnees_Spectres$Annee2023[[ech_voulu]][[lab]])[spectro])
        list_annee <- c(list_annee, 2023)
        list_prot <- c(list_prot, prot_2023[ech_voulu])
      }
    }
  }
}


# plot(type = "l", donnee[[1]], donnee[[2]], ylim = c(- 0.1, 1.1), xlim = c(1000, 1650), xlab = "Longueur d'onde (nm)", ylab = "Absorbance")
# for (i in 2:(length(donnee) / 2)) {
#   lines(donnee[[i * 2 - 1]], donnee[[i * 2]], col = i)
# }
# 
# plot(type = "l", donnee[[1]], donnee[[2]], ylim = c(- 0.1, 1.1), xlim = c(1000, 1650), xlab = "Longueur d'onde (nm)", ylab = "Absorbance")
# for (i in 2:(length(donnee) / 2)) {
#   lines(donnee[[i * 2 - 1]], donnee[[i * 2]], col = ifelse(spectrom[i] == "IDiL FlameNIR", "red", "blue"))
# }
# legend("topleft", legend = c("IDiL FlameNIR", "Le reste"), fill = c("red", "blue"))
# 
# plot(type = "l", donnee[[1]], donnee[[2]], ylim = c(- 0.1, 1.1), xlim = c(1000, 1650), xlab = "Longueur d'onde (nm)", ylab = "Intensité")
# for (i in 2:(length(donnee) / 2)) {
#   if (spectrom[i - 1] != "IDiL FlameNIR") {
#     lines(donnee[[i * 2 - 1]], donnee[[i * 2]], col = ifelse(spectrom[i - 1] == "IDiL FlameNIR", "red", "blue"))
#   }
# }
# legend("topleft", legend = c("IDiL FlameNIR", "Le reste"), fill = c("red", "blue"))
```

```{r}
# Entre 1000 et 1650
# Interpolation linéaire, basique.

# abscisse = data.frame(V1 = c(167:275) * 6)
abscisse = data.frame(V1 = c(1000:1650))

donnee_interpolee <- c(abscisse)
for (i in 1:((length(donnee)) / 2)) {
  donnee_interpolee <- c(donnee_interpolee, data.frame(V2 = approx(donnee[[i * 2 - 1]], donnee[[i * 2]], xout = abscisse[[1]])[[2]]))
}

plot(type = "l", donnee_interpolee[[1]], donnee_interpolee[[2]], ylim = c(- 0.1, 1.1), xlim = c(1000, 1650))
for (i in 3:(length(donnee_interpolee))) {
  lines(donnee_interpolee[[1]], donnee_interpolee[[i]], col = i)
}

plot(type = "l", donnee_interpolee[[1]], donnee_interpolee[[2]] - mean(donnee_interpolee[[2]], na.rm = TRUE), ylim = c(- 0.4, 0.5))
for (i in 3:(length(donnee_interpolee))) {
  lines(donnee_interpolee[[1]], donnee_interpolee[[i]] - mean(donnee_interpolee[[i]], na.rm = TRUE), col = i)
}

plot(type = "l", donnee_interpolee[[1]], (donnee_interpolee[[i]] - mean(donnee_interpolee[[i]], na.rm = TRUE)) / sd(donnee_interpolee[[i]]), ylim = c(- 1.5, 2))
for (i in 3:(length(donnee_interpolee))) {
  lines(donnee_interpolee[[1]], (donnee_interpolee[[i]] - mean(donnee_interpolee[[i]], na.rm = TRUE)) / sd(donnee_interpolee[[i]]), col = i)
}

plot(type = "l", donnee_interpolee[[1]], scale(donnee_interpolee[[2]]), ylim = c(- 1.5, 2), xlim = c(1000, 1650))
for (i in 3:(length(donnee_interpolee))) {
  lines(donnee_interpolee[[1]], scale(donnee_interpolee[[i]]), col = i)
}



plot(type = "l", donnee_interpolee[[1]], donnee_interpolee[[2]], ylim = c(- 0.1, 1.1), xlim = c(1000, 2500))
for (i in 3:(length(donnee_interpolee))) {
  if (spectrom[i - 1] != "IDiL FlameNIR") {
    lines(donnee_interpolee[[1]], donnee_interpolee[[i]], col = i)
  }
}

plot(type = "l", donnee_interpolee[[1]], donnee_interpolee[[2]] - mean(donnee_interpolee[[2]], na.rm = TRUE), ylim = c(- 0.4, 0.6))
for (i in 3:(length(donnee_interpolee))) {
  if (spectrom[i - 1] != "IDiL FlameNIR") {
      lines(donnee_interpolee[[1]], donnee_interpolee[[i]] - mean(donnee_interpolee[[i]], na.rm = TRUE), col = i)
  }
}

plot(type = "l", donnee_interpolee[[1]], (donnee_interpolee[[i]] - mean(donnee_interpolee[[i]], na.rm = TRUE)) / sd(donnee_interpolee[[i]]), ylim = c(- 0.4, 0.6))
for (i in 3:(length(donnee_interpolee))) {
  if (spectrom[i - 1] != "IDiL FlameNIR") {
    lines(donnee_interpolee[[1]], (donnee_interpolee[[i]] - mean(donnee_interpolee[[i]], na.rm = TRUE)) / sd(donnee_interpolee[[i]]), col = i)
  }
}

# plot(donnee_interpolee[[1]], donnee_interpolee[[3]], type = 'l', xlim = c(2490, 2500), ylim = c(0.7, 0.8))

plot(type = "l", donnee_interpolee[[1]], donnee_interpolee[[2]], ylim = c(- 0.1, 1.1), xlim = c(1000, 2500))
for (i in 3:(length(donnee_interpolee))) {
  if (spectrom[i - 1] != "IDiL FlameNIR") {
    lines(donnee_interpolee[[1]], donnee_interpolee[[i]], col = i)
  }
}

plot(type = "l", donnee_interpolee[[1]], donnee_interpolee[[2]], ylim = c(- 0.1, 1.1), xlim = c(1000, 2500))
for (i in 3:(length(donnee_interpolee))) {
  if (spectrom[i - 1] != "IDiL FlameNIR" && spectrom[i - 1] != "VIAVI MicroNIRS") {
    lines(donnee_interpolee[[1]], donnee_interpolee[[i]], col = i)
  }
}
```

# 1000 1650

```{r}
b <- data.frame(do.call(rbind, donnee_interpolee))
colnames(b) <- b[1, ]
plot(y = as.vector(b[2, ]), x = c(1000:1650), type = 'l')
# plot(y = as.vector(b[2, ]), x = c(167:275) * 6, type = 'l')
b = b[- 1, ]

b$lab <- labo
b$ech <- list_ech
b$spectro <- spectrom
b$annee <- list_annee

library("FactoMineR")
res.pca <- PCA(b[- ((length(b) - 3):length(b))], graph = FALSE)
res.pca_no_flamenir <- PCA(b[!(b$spectro %in% "IDiL FlameNIR"), - ((length(b) - 3):length(b))], graph = FALSE)
res.pca_no_flamenir_or_VIAVI <- PCA(b[!(b$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), - ((length(b) - 3):length(b))], graph = FALSE)

# res.pca <- PCA(b[- c(110, 111, 112)], graph = FALSE)

print(res.pca)
res.pca$eig

res.pca_no_flamenir$eig

res.pca_no_flamenir_or_VIAVI$eig

library(factoextra)
fviz_pca_ind(res.pca, label = "none", habillage = as.factor(b$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca, label = "none", habillage = as.factor(b$spectro), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(res.pca, label = "none", habillage = as.factor(b$ech))
fviz_pca_ind(res.pca, label = "none", habillage = as.factor(b$annee))

fviz_pca_ind(res.pca_no_flamenir, label = "none", habillage = as.factor(b[!(b$spectro %in% "IDiL FlameNIR"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir, label = "none", habillage = as.factor(b[!(b$spectro %in% "IDiL FlameNIR"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir, label = "none", habillage = as.factor(b[!(b$spectro %in% "IDiL FlameNIR"), ]$annee))

fviz_pca_ind(res.pca_no_flamenir_or_VIAVI, label = "none", habillage = as.factor(b[!(b$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI, label = "none", habillage = as.factor(b[!(b$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI, label = "none", habillage = as.factor(b[!(b$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95)


c <- b

c <- t(apply(b[, 1:(ncol(b) - 4)], 1, function(row) {
  (row - mean(row)) / sd(row)
}))

c <- cbind(c, b[, (ncol(b) - 3):ncol(b)])

res.pca_mean <- PCA(c[- ((length(c) - 3):length(c))], graph = FALSE)
res.pca_no_flamenir_mean <- PCA(c[!(c$spectro %in% "IDiL FlameNIR"), - ((length(c) - 3):length(c))], graph = FALSE)
res.pca_no_flamenir_or_VIAVI_mean <- PCA(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), - ((length(c) - 3):length(c))], graph = FALSE)

plot.PCA(res.pca_mean, axes = c(1, 2), choix = c("var"))
plot.PCA(res.pca_mean, axes = c(1, 6), choix = c("var"))
plot.PCA(res.pca_mean, axes = c(2, 6), choix = c("var"))
plot.PCA(res.pca_mean, axes = c(3, 6), choix = c("var"))
plot.PCA(res.pca_mean, axes = c(4, 6), choix = c("var"))
plot.PCA(res.pca_mean, axes = c(5, 6), choix = c("var"))

res.pca_mean$eig

res.pca_no_flamenir_mean$eig

res.pca_no_flamenir_or_VIAVI_mean$eig

fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 2))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$annee))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
# fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$ech))

fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$annee), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))

fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 4))


fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(4, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(4, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(4, 5))
```

# 1000 1650 20 ech

```{r}
b <- data.frame(do.call(rbind, donnee_interpolee))
colnames(b) <- b[1, ]
# plot(y = as.vector(b[2, ]), x = c(1000:1650), type = 'l')
# plot(y = as.vector(b[2, ]), x = c(167:275) * 6, type = 'l')
b = b[- 1, ]

b$lab <- labo
b$ech <- list_ech
b$spectro <- spectrom
b$annee <- list_annee

b <- b[1:200, ]

library("FactoMineR")
res.pca <- PCA(b[- ((length(b) - 3):length(b))], graph = FALSE)
res.pca_no_flamenir <- PCA(b[!(b$spectro %in% "IDiL FlameNIR"), - ((length(b) - 3):length(b))], graph = FALSE)
res.pca_no_flamenir_or_VIAVI <- PCA(b[!(b$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), - ((length(b) - 3):length(b))], graph = FALSE)

print(res.pca)
res.pca$eig

res.pca_no_flamenir$eig

res.pca_no_flamenir_or_VIAVI$eig

library(factoextra)
fviz_pca_ind(res.pca, label = "none", habillage = as.factor(b$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca, label = "none", habillage = as.factor(b$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca, label = "none", habillage = as.factor(b$ech))

fviz_pca_ind(res.pca_no_flamenir, label = "none", habillage = as.factor(b[!(b$spectro %in% "IDiL FlameNIR"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir, label = "none", habillage = as.factor(b[!(b$spectro %in% "IDiL FlameNIR"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir, label = "none", habillage = as.factor(b[!(b$spectro %in% "IDiL FlameNIR"), ]$ech))

fviz_pca_ind(res.pca_no_flamenir_or_VIAVI, label = "none", habillage = as.factor(b[!(b$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI, label = "none", habillage = as.factor(b[!(b$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)


c <- b

c <- t(apply(b[, 1:(ncol(b) - 4)], 1, function(row) {
  (row - mean(row)) / sd(row)
}))

c <- cbind(c, b[, (ncol(b) - 3):ncol(b)])

res.pca_mean <- PCA(c[- ((length(c) - 3):length(c))], graph = FALSE)
res.pca_no_flamenir_mean <- PCA(c[!(c$spectro %in% "IDiL FlameNIR"), - ((length(c) - 3):length(c))], graph = FALSE)
res.pca_no_flamenir_or_VIAVI_mean <- PCA(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), - ((length(c) - 3):length(c))], graph = FALSE)

plot.PCA(res.pca_mean, axes = c(1, 2), choix = c("var"))
plot.PCA(res.pca_mean, axes = c(1, 6), choix = c("var"))
plot.PCA(res.pca_mean, axes = c(2, 6), choix = c("var"))
plot.PCA(res.pca_mean, axes = c(3, 6), choix = c("var"))
plot.PCA(res.pca_mean, axes = c(4, 6), choix = c("var"))
plot.PCA(res.pca_mean, axes = c(5, 6), choix = c("var"))

res.pca_mean$eig

res.pca_no_flamenir_mean$eig

res.pca_no_flamenir_or_VIAVI_mean$eig

fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 2))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$annee))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
# fviz_pca_ind(res.pca_mean, label = "none", habillage = as.factor(c$ech))

fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$annee), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_no_flamenir_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% "IDiL FlameNIR"), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))

fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 4))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 4))


fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(3, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95, axes = c(4, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(4, 5))
fviz_pca_ind(res.pca_no_flamenir_or_VIAVI_mean, label = "none", habillage = as.factor(c[!(c$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95, axes = c(4, 5))
```

```{r}

model.pca <- prcomp(c[- ((length(c) - 3):length(c))],
                    center = TRUE,
                    scale = TRUE,
                    rank. = 5)

b.P <- model.pca$rotation
b.T <- model.pca$x

# Baseline: mean and standard deviation per column
b.mean <- apply(c[- ((length(c) - 3):length(c))], 2, mean, na.rm = TRUE)
b.sd <- apply(c[- ((length(c) - 3):length(c))], 2, sd, na.rm = TRUE)

# Remove the calculated mean from each column (margin=2)
# by using the subtract function (FUN argument)
b.mc <- sweep(c[- ((length(c) - 3):length(c))], 2, b.mean, FUN = '-')

# Scale each column, dividing by the standard deviation
b.mcuv <- sweep(b.mc, 2, b.sd, FUN = '/')

# Baseline variance
b.X2 <- b.mcuv * b.mcuv

# A = 1
#------
a = 1
b.Xhat.a <- b.T[,seq(1,a)] %*% t(b.P[,seq(1,a)])
b.E <- b.mcuv - b.Xhat.a
b.E2 <- b.E * b.E
b.Xhat.a.2 <- b.Xhat.a * b.Xhat.a

SPE.1 <- sqrt(apply(b.E2, 1, sum))
R2.k.a <- apply(b.Xhat.a.2, 2, sum) / apply(b.X2, 2, sum)

wavelengths <- seq(1000, 1650, 1)
plot(wavelengths, R2.k.a, col = 'darkgreen',
     type = 'l', lwd = a * 2, ylim = c(0, 1),
     ylab = expression("R"^2*" per component (wavelength)"),
     xlab = "Wavelengths")

# A = 2
#------
a = 2
b.Xhat.a <- b.T[, seq(1, a)] %*% t(b.P[, seq(1, a)])
b.E <- b.mcuv - b.Xhat.a

# mean for each row
b.E.mean <- apply(b.E, 1, mean, na.rm = TRUE)
b.E2 <- b.E * b.E
b.Xhat.a.2 <- b.Xhat.a * b.Xhat.a

SPE.2 <- sqrt(apply(b.E2, 1, sum))
R2.k.a <- apply(b.Xhat.a.2, 2, sum) / apply(b.X2, 2, sum)

lines(wavelengths, R2.k.a, col = 'black', type = 'l', lwd = a * 2)


# A = 3
#------
a = 3
b.Xhat.a <- b.T[, seq(1, a)] %*% t(b.P[, seq(1, a)])
b.E <- b.mcuv - b.Xhat.a
b.E2 <- b.E * b.E
b.Xhat.a.2 <- b.Xhat.a * b.Xhat.a

SPE.3 <- sqrt(apply(b.E2, 1, sum))
R2.k.a <- apply(b.Xhat.a.2, 2, sum) / apply(b.X2, 2, sum)

lines(wavelengths, R2.k.a, col = 'blue', type = 'l')


# A = 4
#------
a = 4
b.Xhat.a <- b.T[, seq(1, a)] %*% t(b.P[, seq(1, a)])
b.E <- b.mcuv - b.Xhat.a
b.E2 <- b.E * b.E
b.Xhat.a.2 <- b.Xhat.a * b.Xhat.a

SPE.4 <- sqrt(apply(b.E2, 1, sum))
R2.k.a <- apply(b.Xhat.a.2, 2, sum) / apply(b.X2, 2, sum)

lines(wavelengths, R2.k.a, col = 4, type = 'l')



# A = 5
#------
a = 5
b.Xhat.a <- b.T[, seq(1, a)] %*% t(b.P[, seq(1, a)])
b.E <- b.mcuv - b.Xhat.a
b.E2 <- b.E * b.E
b.Xhat.a.2 <- b.Xhat.a * b.Xhat.a

SPE.5 <- sqrt(apply(b.E2, 1, sum))
R2.k.a <- apply(b.Xhat.a.2, 2, sum) / apply(b.X2, 2, sum)

lines(wavelengths, R2.k.a, col = 5, type = 'l')




# A = 6
#------
a = 6
b.Xhat.a <- b.T[, seq(1, a)] %*% t(b.P[, seq(1, a)])
b.E <- b.mcuv - b.Xhat.a
b.E2 <- b.E * b.E
b.Xhat.a.2 <- b.Xhat.a * b.Xhat.a

SPE.6 <- sqrt(apply(b.E2, 1, sum))
R2.k.a <- apply(b.Xhat.a.2, 2, sum) / apply(b.X2, 2, sum)

lines(wavelengths, R2.k.a, col = 6, type = 'l')




# A = 7
#------
a = 7
b.Xhat.a <- b.T[, seq(1, a)] %*% t(b.P[, seq(1, a)])
b.E <- b.mcuv - b.Xhat.a
b.E2 <- b.E * b.E
b.Xhat.a.2 <- b.Xhat.a * b.Xhat.a

SPE.7 <- sqrt(apply(b.E2, 1, sum))
R2.k.a <- apply(b.Xhat.a.2, 2, sum) / apply(b.X2, 2, sum)

lines(wavelengths, R2.k.a, col = 7, type = 'l')




# A = 8
#------
a = 8
b.Xhat.a <- b.T[, seq(1, a)] %*% t(b.P[, seq(1, a)])
b.E <- b.mcuv - b.Xhat.a
b.E2 <- b.E * b.E
b.Xhat.a.2 <- b.Xhat.a * b.Xhat.a

SPE.8 <- sqrt(apply(b.E2, 1, sum))
R2.k.a <- apply(b.Xhat.a.2, 2, sum) / apply(b.X2, 2, sum)

lines(wavelengths, R2.k.a, col = 8, type = 'l')




# A = 9
#------
a = 9
b.Xhat.a <- b.T[, seq(1, a)] %*% t(b.P[, seq(1, a)])
b.E <- b.mcuv - b.Xhat.a
b.E2 <- b.E * b.E
b.Xhat.a.2 <- b.Xhat.a * b.Xhat.a

SPE.9 <- sqrt(apply(b.E2, 1, sum))
R2.k.a <- apply(b.Xhat.a.2, 2, sum) / apply(b.X2, 2, sum)

lines(wavelengths, R2.k.a, col = 9, type = 'l')


legend(x = 1000, y = 0.35,
       legend = c(expression("R"^2*": 1st component"),
                expression("R"^2*": 2nd component"),
                expression("R"^2*": 3rd component"),
                expression("R"^2*": 4nd component"),
                expression("R"^2*": 5nd component"),
                expression("R"^2*": 6nd component"),
                expression("R"^2*": 7nd component"),
                expression("R"^2*": 8nd component"),
                expression("R"^2*": 9nd component")),
       col = c("darkgreen", "black", "blue", 4, 5, 6, 7, 8, 9),
       lty = c(1, 1, 1), lwd = c(2, 4, 6), cex = 1.0)




# SPE plot
N <- dim(b)[1]
layout(matrix(c(1,2,3), 3, 1))
plot(seq(1, N), SPE.1, col = 'darkgreen',
    type = 'l', lwd = 2,  ylab = "SPE: A = 1",
    ylim = c(0, max(SPE.1)))
plot(seq(1, N), SPE.2, col = 'black',
     type = 'l', lwd = 2,  ylab = "SPE: A = 2",
     ylim = c(0, max(SPE.2)))
plot(seq(1, N), SPE.3, col = 'blue',
     type = 'l', lwd = 2,  ylab = "SPE: A = 3",
     xlab = "Tablet number", ylim = c(0, max(SPE.3)))

```

```{r}
csv = data.frame(Reduce(rbind, donnee_interpolee))
colnames(csv) <- csv[1, ]
csv = csv[- 1, ]
write.csv(csv, "nomorecolumns.csv", row.names = FALSE)
write.csv(csv, "nomorecolumns_name.csv", row.names = TRUE)

csv$lab <- labo
csv$ech <- list_ech
csv$spectro <- spectrom
write.csv(csv, "morecolumns.csv", row.names = FALSE)
write.csv(csv, "morecolumns_name.csv", row.names = TRUE)
```

# Interpolation 1000 1650 + prétraitement

```{r}
library(signal)
library(baseline)

abscisse_1000_1650 = data.frame(V1 = seq(1000, 1650, 1))

# Interpolation

donnee_interpolee_1000_1650 <- c(abscisse_1000_1650)
for (i in 1:((length(donnee)) / 2)) {
  donnee_interpolee_1000_1650 <- c(donnee_interpolee_1000_1650, data.frame(V2 = approx(donnee[[i * 2 - 1]], donnee[[i * 2]], xout = abscisse_1000_1650[[1]])[[2]]))
}

# Savitzky-Golay

window_sizes <- seq(5, 9, by = 2)

poly_degrees <- 2:5

errors <- matrix(0, nrow = length(window_sizes), ncol = length(poly_degrees))

calc_rmse <- function(original, smoothed) {
  sqrt(mean((original - smoothed)^2))
}

for (i in seq_along(window_sizes)) {
  window_size <- window_sizes[i]
  for (j in seq_along(poly_degrees)) {
    poly_degree <- poly_degrees[j]
    if (window_size > poly_degree) {
      for (k in 2:length(donnee_interpolee_1000_1650)) {
        smoothed_spectrum <- sgolayfilt(donnee_interpolee_1000_1650[[k]], p = poly_degree, n = window_size)
        errors[i, j] <- errors[i, j] + calc_rmse(donnee_interpolee_1000_1650[[k]], smoothed_spectrum)
      }
    }
  }
}

errors[1, 3] <- mean(errors) * 15 / 13
errors[1, 4] <- mean(errors) * 15 / 13

best_indices <- which(errors == min(errors), arr.ind = TRUE)
best_window_size <- window_sizes[best_indices[1]]
best_poly_degree <- poly_degrees[best_indices[2]]

print(paste("Taille de fenêtre optimale :", best_window_size))
print(paste("Degré de polynôme optimal :", best_poly_degree))

library(ggplot2)
error_df <- expand.grid(WindowSize = window_sizes, PolyDegree = poly_degrees)
error_df$RMSE <- as.vector(errors)

ggplot(error_df, aes(x = WindowSize, y = PolyDegree, fill = RMSE)) +
  geom_tile() +
  scale_fill_gradient(low = "red", high = "blue") +
  labs(title = "Carte des erreurs RMSE pour différentes tailles de fenêtres et degrés de polynômes",
       x = "Taille de fenêtre",
       y = "Degré de polynôme") +
  theme_minimal()

donnee_interpolee_SG_1000_1650 <- c(abscisse_1000_1650)
for (i in 2:length(donnee_interpolee_1000_1650)) {
  donnee_interpolee_SG_1000_1650 <- c(donnee_interpolee_SG_1000_1650, data.frame(V2 = sgolayfilt(donnee_interpolee_1000_1650[[i]], p = best_poly_degree, n = best_window_size)))
}

# Detrend (Baseline)

donnee_interpolee_BL_SG_1000_1650 <- c(abscisse_1000_1650)
for (i in 2:length(donnee_interpolee_SG_1000_1650)) {
  donnee_interpolee_BL_SG_1000_1650 <- c(donnee_interpolee_BL_SG_1000_1650, data.frame(V2 = as.vector(getCorrected(baseline(matrix(donnee_interpolee_SG_1000_1650[[i]], nrow = 1))))))
}

# SNV (Normalisation)

donnee_interpolee_N_BL_SG_1000_1650 <- c(abscisse_1000_1650)
for (i in 2:length(donnee_interpolee_BL_SG_1000_1650)) {
  donnee_interpolee_N_BL_SG_1000_1650 <- c(donnee_interpolee_N_BL_SG_1000_1650, data.frame(V2 = scale(donnee_interpolee_BL_SG_1000_1650[[i]])))
}

# plot(type = "l", donnee_interpolee_N_BL_SG_1000_1650[[1]], donnee_interpolee_N_BL_SG_1000_1650[[2]], ylim = c(- 1.5, 2.2), xlim = c(1000, 1650), xlab = "Longueur d'onde (nm)", ylab = "Intensité")
# for (i in 3:(length(donnee_interpolee_N_BL_SG_1000_1650))) {
#   lines(donnee_interpolee_N_BL_SG_1000_1650[[1]], donnee_interpolee_N_BL_SG_1000_1650[[i]], col = i)
# }
# 
# plot(type = "l", donnee_interpolee_N_BL_SG_1000_1650[[1]], donnee_interpolee_N_BL_SG_1000_1650[[2]], ylim = c(- 1.5, 2.2), xlim = c(1000, 1650), xlab = "Longueur d'onde (nm)", ylab = "Intensité")
# for (i in 3:(length(donnee_interpolee_N_BL_SG_1000_1650))) {
#   lines(donnee_interpolee_N_BL_SG_1000_1650[[1]], donnee_interpolee_N_BL_SG_1000_1650[[i]], col = ifelse(spectrom[i - 1] == "IDiL FlameNIR", "red", "blue"))
# }
# legend("topleft", legend = c("IDiL FlameNIR", "Le reste"), fill = c("red", "blue"))
# 
# plot(type = "l", donnee_interpolee_N_BL_SG_1000_1650[[1]], donnee_interpolee_N_BL_SG_1000_1650[[2]], ylim = c(- 1.5, 2.2), xlim = c(1000, 1650), xlab = "Longueur d'onde (nm)", ylab = "Intensité")
# for (i in 3:(length(donnee_interpolee_N_BL_SG_1000_1650))) {
#   if (spectrom[i - 1] != "IDiL FlameNIR") {
#     lines(donnee_interpolee_N_BL_SG_1000_1650[[1]], donnee_interpolee_N_BL_SG_1000_1650[[i]], col = ifelse(spectrom[i - 1] == "IDiL FlameNIR", "red", "blue"))
#   } else {
#     lines(donnee_interpolee_N_BL_SG_1000_1650[[1]] - 5, donnee_interpolee_N_BL_SG_1000_1650[[i]], col = ifelse(spectrom[i - 1] == "IDiL FlameNIR", "red", "blue"))
#   }
# }
# legend("topleft", legend = c("IDiL FlameNIR", "Le reste"), fill = c("red", "blue"))

```

# Vraie analyse ACP 1000 1650

```{r}
library(FactoMineR)
library(factoextra)
library(heplots)
library(car)

assign("df_donnee_interpolee_N_BL_SG_1000_1650", data.frame(do.call(rbind, donnee_interpolee_N_BL_SG_1000_1650)))
colnames(df_donnee_interpolee_N_BL_SG_1000_1650) <- df_donnee_interpolee_N_BL_SG_1000_1650[1, ]
df_donnee_interpolee_N_BL_SG_1000_1650 = df_donnee_interpolee_N_BL_SG_1000_1650[- 1, ]

df_donnee_interpolee_N_BL_SG_1000_1650$lab <- labo
df_donnee_interpolee_N_BL_SG_1000_1650$ech <- list_ech
df_donnee_interpolee_N_BL_SG_1000_1650$spectro <- spectrom
df_donnee_interpolee_N_BL_SG_1000_1650$annee <- list_annee
df_donnee_interpolee_N_BL_SG_1000_1650$prot <- list_prot

ACP_preteatment_1000_1650 <- PCA(df_donnee_interpolee_N_BL_SG_1000_1650[- ((length(df_donnee_interpolee_N_BL_SG_1000_1650) - 4):length(df_donnee_interpolee_N_BL_SG_1000_1650))], graph = FALSE)

# ACP_preteatment_1000_1650_no_flamenir <- PCA(df_donnee_interpolee_N_BL_SG_1000_1650[!(df_donnee_interpolee_N_BL_SG_1000_1650$spectro %in% "IDiL FlameNIR"), - ((length(df_donnee_interpolee_N_BL_SG_1000_1650) - 4):length(df_donnee_interpolee_N_BL_SG_1000_1650))], graph = FALSE)
# 
# ACP_preteatment_1000_1650_no_flamenir_or_VIAVI <- PCA(df_donnee_interpolee_N_BL_SG_1000_1650[!(df_donnee_interpolee_N_BL_SG_1000_1650$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), - ((length(df_donnee_interpolee_N_BL_SG_1000_1650) - 4):length(df_donnee_interpolee_N_BL_SG_1000_1650))], graph = FALSE)

ACP_preteatment_1000_1650$eig
fviz_eig(ACP_preteatment_1000_1650, addlabels = TRUE, ylim = c(0, 60))


fviz_pca_ind(ACP_preteatment_1000_1650, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_1650$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_1000_1650, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_1650$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_1000_1650, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_1650$annee))

# fviz_pca_ind(ACP_preteatment_1000_1650_no_flamenir, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_1650[!(df_donnee_interpolee_N_BL_SG_1000_1650$spectro %in% "IDiL FlameNIR"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_1000_1650_no_flamenir, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_1650[!(df_donnee_interpolee_N_BL_SG_1000_1650$spectro %in% "IDiL FlameNIR"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_1000_1650_no_flamenir, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_1650[!(df_donnee_interpolee_N_BL_SG_1000_1650$spectro %in% "IDiL FlameNIR"), ]$annee))
# 
# fviz_pca_ind(ACP_preteatment_1000_1650_no_flamenir_or_VIAVI, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_1650[!(df_donnee_interpolee_N_BL_SG_1000_1650$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_1000_1650_no_flamenir_or_VIAVI, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_1650[!(df_donnee_interpolee_N_BL_SG_1000_1650$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_1000_1650_no_flamenir_or_VIAVI, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_1650[!(df_donnee_interpolee_N_BL_SG_1000_1650$spectro %in% c("IDiL FlameNIR", "VIAVI MicroNIRS")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95)

# Significativé année avec test et effect size

scores_1000_1650 <- ACP_preteatment_1000_1650$ind$coord
scores_df_1000_1650 <- data.frame(scores_1000_1650, Year = factor(df_donnee_interpolee_N_BL_SG_1000_1650$annee))
MANOVA_1_2_1000_1650 <- manova(cbind(Dim.1, Dim.2) ~ Year, data = scores_df_1000_1650)

manova_summary_1_2_1000_1650 <- summary(MANOVA_1_2_1000_1650, test = "Pillai")
# sum(diag(SS_year_matrix %*% solve(SS_year_matrix + SS_residuals_matrix))) # valeur du test de Pillai
etasq_P_1_2_1000_1650 <- manova_summary_1_2_1000_1650$stats[1, 2] / (manova_summary_1_2_1000_1650$stats[1, 2] + 5980 - 2 - 1)
etasq_P_1_2_1000_1650 # effect size de Pillai.
summary(MANOVA_1_2_1000_1650, test = "Wilks")
# 1 - summary(MANOVA_1_2_1000_1650, test = "Wilks")$stats[1, 2] # Calcul effect size Wilks
etasq_W <- etasq(MANOVA_1_2_1000_1650, anova = TRUE)
etasq_W[1, 1] # effect size de Wilks.

# Appliquer le test de Levene sur les scores de la première composante principale (Dim.1)
leveneTest(Dim.1 ~ Year, data = scores_df_1000_1650)

# Loadings par Longueurs d'onde

loadings_1000_1650 <- ACP_preteatment_1000_1650$var$coord
loading_pc1_1000_1650 <- loadings_1000_1650[, 1]

plot(seq(1000, 1650, 1), loading_pc1_1000_1650, type = 'l', xlab = 'Longueur d\'onde', ylab = 'Loading', 
     main = 'Loadings de la première composante principale')
for (i in 2:5) {
  lines(seq(1000, 1650, 1), loadings_1000_1650[, i], col = i)
}

fviz_pca_var(ACP_preteatment_1000_1650, label = "none")

# plot(type = "l", donnee_interpolee_N_BL_SG_1000_1650[[1]], donnee_interpolee_N_BL_SG_1000_1650[[2]], ylim = c(- 1.5, 2.2), xlim = c(1000, 1650))
# for (i in 3:(length(donnee_interpolee_N_BL_SG_1000_1650))) {
#   lines(donnee_interpolee_N_BL_SG_1000_1650[[1]], donnee_interpolee_N_BL_SG_1000_1650[[i]], col = i)
# }
```

# Vraie analyse PLS 1000 1650

```{r}
library(pls)

matrix_donnee_interpolee_N_BL_SG_1000_1650 <- as.matrix(df_donnee_interpolee_N_BL_SG_1000_1650[- ((length(df_donnee_interpolee_N_BL_SG_1000_1650) - 4):length(df_donnee_interpolee_N_BL_SG_1000_1650))])

assign("matrix_donnee_interpolee_N_BL_SG_1000_1650_Lusignan", matrix_donnee_interpolee_N_BL_SG_1000_1650[df_donnee_interpolee_N_BL_SG_1000_1650$lab == "URP3F_Lusignan", ]) # R plante si je n'utilise pas assign(), je ne sais pas pourquoi.

prot_numeric <- as.numeric(df_donnee_interpolee_N_BL_SG_1000_1650$prot)

pls_1000_1650_Lusignan <- plsr(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_1650$lab == "URP3F_Lusignan"] ~ matrix_donnee_interpolee_N_BL_SG_1000_1650_Lusignan, ncomp = 10, validation = "CV")

explvar(pls_1000_1650_Lusignan)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_1650_Lusignan, ncomp = 10)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_1650$lab == "URP3F_Lusignan"], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles")
abline(0, 1, col = "red")

validationplot(pls_1000_1650_Lusignan, val.type = "RMSEP")

# Visualisation des coefficients
# coefplot(pls_1000_1650_Lusignan, ncomp = 10)
```

# Interpolation 1000 2498 + prétraitement

```{r}
library(signal)
library(baseline)
library(ggplot2)

abscisse_1000_2498 = data.frame(V1 = c(1000:2498))

# Interpolation

labo_1000_2498 <- c()
list_ech_1000_2498 <- c()
spectrom_1000_2498 <- c()
list_annee_1000_2498 <- c()
list_prot_1000_2498 <- c()
    
donnee_interpolee_1000_2498 <- c(abscisse_1000_2498)
for (i in 1:((length(donnee)) / 2)) {
  if (max(donnee[[i * 2 - 1]]) > 2000) {
    donnee_interpolee_1000_2498 <- c(donnee_interpolee_1000_2498, data.frame(V2 = approx(donnee[[i * 2 - 1]], donnee[[i * 2]], xout = abscisse_1000_2498[[1]])[[2]]))
    labo_1000_2498 <- c(labo_1000_2498, labo[[i]])
    list_ech_1000_2498 <- c(list_ech_1000_2498, list_ech[[i]])
    spectrom_1000_2498 <- c(spectrom_1000_2498, spectrom[[i]])
    list_annee_1000_2498 <- c(list_annee_1000_2498, list_annee[[i]])
    list_prot_1000_2498 <- c(list_prot_1000_2498, list_prot[[i]])
  }
}

# Savitzky-Golay

window_sizes <- seq(5, 9, by = 2)

poly_degrees <- 2:5

errors <- matrix(0, nrow = length(window_sizes), ncol = length(poly_degrees))

calc_rmse <- function(original, smoothed) {
  sqrt(mean((original - smoothed)^2))
}

for (i in seq_along(window_sizes)) {
  window_size <- window_sizes[i]
  for (j in seq_along(poly_degrees)) {
    poly_degree <- poly_degrees[j]
    if (window_size > poly_degree) {
      for (k in 2:length(donnee_interpolee_1000_2498)) {
        smoothed_spectrum <- sgolayfilt(donnee_interpolee_1000_2498[[k]], p = poly_degree, n = window_size)
        errors[i, j] <- errors[i, j] + calc_rmse(donnee_interpolee_1000_2498[[k]], smoothed_spectrum)
      }
    }
  }
}

errors[1, 3] <- mean(errors) * 15 / 13
errors[1, 4] <- mean(errors) * 15 / 13

best_indices <- which(errors == min(errors), arr.ind = TRUE)
best_window_size <- window_sizes[best_indices[1]]
best_poly_degree <- poly_degrees[best_indices[2]]

print(paste("Taille de fenêtre optimale :", best_window_size))
print(paste("Degré de polynôme optimal :", best_poly_degree))

error_df <- expand.grid(WindowSize = window_sizes, PolyDegree = poly_degrees)
error_df$RMSE <- as.vector(errors)

ggplot(error_df, aes(x = WindowSize, y = PolyDegree, fill = RMSE)) +
  geom_tile() +
  scale_fill_gradient(low = "red", high = "blue") +
  labs(title = "Carte des erreurs RMSE pour différentes tailles de fenêtres et degrés de polynômes",
       x = "Taille de fenêtre",
       y = "Degré de polynôme") +
  theme_minimal()

donnee_interpolee_SG_1000_2498 <- c(abscisse_1000_2498)
for (i in 2:length(donnee_interpolee_1000_2498)) {
  donnee_interpolee_SG_1000_2498 <- c(donnee_interpolee_SG_1000_2498, data.frame(V2 = sgolayfilt(donnee_interpolee_1000_2498[[i]], p = best_poly_degree, n = best_window_size)))
}

# Detrend (Baseline)

donnee_interpolee_BL_SG_1000_2498 <- c(abscisse_1000_2498)
for (i in 2:length(donnee_interpolee_SG_1000_2498)) {
  donnee_interpolee_BL_SG_1000_2498 <- c(donnee_interpolee_BL_SG_1000_2498, data.frame(V2 = as.vector(getCorrected(baseline(matrix(donnee_interpolee_SG_1000_2498[[i]], nrow = 1))))))
}

# SNV (Normalisation)

donnee_interpolee_N_BL_SG_1000_2498 <- c(abscisse_1000_2498)
for (i in 2:length(donnee_interpolee_BL_SG_1000_2498)) {
  donnee_interpolee_N_BL_SG_1000_2498 <- c(donnee_interpolee_N_BL_SG_1000_2498, data.frame(V2 = scale(donnee_interpolee_BL_SG_1000_2498[[i]])))
}

# plot(type = "l", donnee[[1]], donnee[[2]], ylim = c(- 0.1, 1.1), xlim = c(1000, 2498), xlab = "Longueur d'onde (nm)", ylab = "Absorbance")
# for (i in 2:(length(donnee) / 2)) {
#   if (max(donnee[[i * 2 - 1]]) > 2000) {
#     lines(donnee[[i * 2 - 1]], donnee[[i * 2]], col = i)
#   }
# }
# 
# plot(type = "l", donnee[[1]], donnee[[2]], ylim = c(- 0.1, 1.1), xlim = c(1000, 1650), xlab = "Longueur d'onde (nm)", ylab = "Absorbance")
# for (i in 2:(length(donnee) / 2)) {
#   if (max(donnee[[i * 2 - 1]]) > 2000) {
#     lines(donnee[[i * 2 - 1]], donnee[[i * 2]], col = ifelse(spectrom[i] == "Thermo Antaris II etuve", "red", "blue"))
#   }
# }
# legend("topleft", legend = c("Thermo Antaris II etuve", "Le reste"), fill = c("red", "blue"))
# 
# plot(type = "l", donnee_interpolee_N_BL_SG_1000_2498[[1]], donnee_interpolee_N_BL_SG_1000_2498[[2]], ylim = c(- 2, 3), xlim = c(1000, 2498), xlab = "Longueur d'onde (nm)", ylab = "Intensité")
# for (i in 3:(length(donnee_interpolee_N_BL_SG_1000_2498))) {
#   lines(donnee_interpolee_N_BL_SG_1000_2498[[1]], donnee_interpolee_N_BL_SG_1000_2498[[i]], col = i)
# }
# 
# plot(type = "l", donnee_interpolee_N_BL_SG_1000_2498[[1]], donnee_interpolee_N_BL_SG_1000_2498[[2]], ylim = c(- 2, 3), xlim = c(1000, 2498), xlab = "Longueur d'onde (nm)", ylab = "Intensité")
# for (i in 3:(length(donnee_interpolee_N_BL_SG_1000_2498))) {
#   lines(donnee_interpolee_N_BL_SG_1000_2498[[1]], donnee_interpolee_N_BL_SG_1000_2498[[i]], col = ifelse(spectrom_1000_2498[i - 1] == "Thermo Antaris II etuve", "red", "blue"))
# }
# legend("topleft", legend = c("Thermo Antaris II etuve", "Le reste"), fill = c("red", "blue"))
```

# Vraie analyse ACP 1000 2498

```{r}
library(FactoMineR)
library(factoextra)
library(heplots)
library(car)

df_donnee_interpolee_N_BL_SG_1000_2498 <- data.frame(do.call(rbind, donnee_interpolee_N_BL_SG_1000_2498))
colnames(df_donnee_interpolee_N_BL_SG_1000_2498) <- df_donnee_interpolee_N_BL_SG_1000_2498[1, ]
df_donnee_interpolee_N_BL_SG_1000_2498 = df_donnee_interpolee_N_BL_SG_1000_2498[- 1, ]

df_donnee_interpolee_N_BL_SG_1000_2498$lab <- labo_1000_2498
df_donnee_interpolee_N_BL_SG_1000_2498$ech <- list_ech_1000_2498
df_donnee_interpolee_N_BL_SG_1000_2498$spectro <- spectrom_1000_2498
df_donnee_interpolee_N_BL_SG_1000_2498$annee <- list_annee_1000_2498
df_donnee_interpolee_N_BL_SG_1000_2498$prot <- list_prot_1000_2498


ACP_preteatment_1000_2498 <- PCA(df_donnee_interpolee_N_BL_SG_1000_2498[- ((length(df_donnee_interpolee_N_BL_SG_1000_2498) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2498))], graph = FALSE)

# ACP_preteatment_1000_2498_no_Thermo_Antaris_II_etuve <- PCA(df_donnee_interpolee_N_BL_SG_1000_2498[!(df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II etuve")), - ((length(df_donnee_interpolee_N_BL_SG_1000_2498) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2498))], graph = FALSE)

ACP_preteatment_1000_2498_only_Thermo_Antaris_II <- PCA(df_donnee_interpolee_N_BL_SG_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), - ((length(df_donnee_interpolee_N_BL_SG_1000_2498) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2498))], graph = FALSE)

ACP_preteatment_1000_2498$eig
fviz_eig(ACP_preteatment_1000_2498, addlabels = TRUE, ylim = c(0, 50))


fviz_pca_ind(ACP_preteatment_1000_2498, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_1000_2498, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_1000_2498, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498$annee), addEllipses = TRUE, ellipse.level = 0.95)

fviz_pca_var(ACP_preteatment_1000_2498, label = "none")

# fviz_pca_ind(ACP_preteatment_1000_2498, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
# fviz_pca_ind(ACP_preteatment_1000_2498, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
# 
# 
# fviz_pca_ind(ACP_preteatment_1000_2498_no_Thermo_Antaris_II_etuve, label = "none",
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498[!(df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II etuve")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_1000_2498_no_Thermo_Antaris_II_etuve, label = "none",
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498[!(df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II etuve")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_1000_2498_no_Thermo_Antaris_II_etuve, label = "none",
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498[!(df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II etuve")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95)
# 
# fviz_pca_ind(ACP_preteatment_1000_2498_only_Thermo_Antaris_II, label = "none",
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_1000_2498_only_Thermo_Antaris_II, label = "none",
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
# 
# # Significativé année avec test et effect size
# 
# scores_1000_2498 <- ACP_preteatment_1000_2498$ind$coord
# scores_df_1000_2498 <- data.frame(scores_1000_2498, Year = factor(df_donnee_interpolee_N_BL_SG_1000_2498$annee))
# MANOVA_1_2_1000_2498 <- manova(cbind(Dim.1, Dim.2) ~ Year, data = scores_df_1000_2498)
# 
# manova_summary_1_2_1000_2498 <- summary(MANOVA_1_2_1000_2498, test = "Pillai")
# # sum(diag(SS_year_matrix %*% solve(SS_year_matrix + SS_residuals_matrix))) # valeur du test de Pillai
# etasq_P_1_2_1000_2498 <- manova_summary_1_2_1000_2498$stats[1, 2] / (manova_summary_1_2_1000_2498$stats[1, 2] + 5980 - 2 - 1)
# etasq_P_1_2_1000_2498 # effect size de Pillai.
# summary(MANOVA_1_2_1000_2498, test = "Wilks")
# # 1 - summary(MANOVA_1_2_1000_2498, test = "Wilks")$stats[1, 2] # Calcul effect size Wilks
# etasq_W <- etasq(MANOVA_1_2_1000_2498, anova = TRUE)
# etasq_W[1, 1] # effect size de Wilks.
# 
# # Appliquer le test de Levene sur les scores de la première composante principale (Dim.1)
# leveneTest(Dim.1 ~ Year, data = scores_df_1000_2498)
# 
# Loadings par Longueurs d'onde

loadings_1000_2498 <- ACP_preteatment_1000_2498$var$coord
loading_pc1_1000_2498 <- loadings_1000_2498[, 1]

plot(1000:2498, loading_pc1_1000_2498, type = 'l', xlab = 'Longueur d\'onde (nm)', ylab = 'Loading', lwd = 2)
abline(v = 1190, col = "red", lwd = 2)
abline(v = 1450, col = "red", lwd = 2)
abline(v = 1940, col = "red", lwd = 2)
abline(h = 0, col = "black", lty = 3)
legend(2100, - 0.7, fill = c("black", "red"), legend = c("CP1", "Zone d'influence de l'eau"), box.lty = 0)
rect(xleft = 1190 - 15, xright = 1190 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
rect(xleft = 1450 - 15, xright = 1450 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
rect(xleft = 1940 - 15, xright = 1940 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)


plot(1000:2498, loading_pc1_1000_2498, type = 'l', xlab = 'Longueur d\'onde (nm)', ylab = 'Loading', lwd = 2)
abline(v = 1190, col = "red", lwd = 2)
abline(v = 1450, col = "red", lwd = 2)
abline(v = 1940, col = "red", lwd = 2)
abline(h = 0, col = "black", lty = 3)
legend(2100, - 0.7, fill = c("black", "red", "white"), legend = c("CP1", "Zone d'influence de l'eau", "CP2 à 5"), box.lty = 0)
rect(xleft = 1190 - 15, xright = 1190 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
rect(xleft = 1450 - 15, xright = 1450 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
rect(xleft = 1940 - 15, xright = 1940 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
for (i in 2:5) {
  lines(1000:2498, loadings_1000_2498[, i], col = i)
}

# loadings_1000_2498_no_Thermo_Antaris_II_etuve <- ACP_preteatment_1000_2498_no_Thermo_Antaris_II_etuve$var$coord
# loading_pc1_1000_2498_no_Thermo_Antaris_II_etuve <- loadings_1000_2498_no_Thermo_Antaris_II_etuve[, 1]
# 
# plot(1000:2498, loading_pc1_1000_2498_no_Thermo_Antaris_II_etuve, type = 'l', xlab = 'Longueur d\'onde', ylab = 'Loading', 
#      main = 'Loadings de la première composante principale')
# abline(v = 1190, col = "red")
# abline(v = 1450, col = "red")
# abline(v = 1940, col = "red")
# abline(v = 2500, col = "red")
# for (i in 2:5) {
#   lines(1000:2498, loadings_1000_2498_no_Thermo_Antaris_II_etuve[, i], col = i)
# }

loadings_1000_2498_only_Thermo_Antaris_II <- ACP_preteatment_1000_2498_only_Thermo_Antaris_II$var$coord
loading_pc1_1000_2498_only_Thermo_Antaris_II <- loadings_1000_2498_only_Thermo_Antaris_II[, 1]

plot(1000:2498, loading_pc1_1000_2498_only_Thermo_Antaris_II, type = 'l', xlab = 'Longueur d\'onde', ylab = 'Loading', 
     main = 'Loadings de la première composante principale', lwd = 2)
abline(v = 1190, col = "red", lwd = 2)
abline(v = 1450, col = "red", lwd = 2)
abline(v = 1940, col = "red", lwd = 2)
abline(h = 0, col = "black", lty = 3)
legend(950, - 0.7, "black", legend = "CP1", box.lty = 0)

plot(1000:2498, loading_pc1_1000_2498_only_Thermo_Antaris_II, type = 'l', xlab = 'Longueur d\'onde', ylab = 'Loading', 
     main = 'Loadings de la première composante principale', lwd = 2)
abline(v = 1190, col = "red", lwd = 2)
abline(v = 1450, col = "red", lwd = 2)
abline(v = 1940, col = "red", lwd = 2)
abline(h = 0, col = "black", lty = 3)
legend(950, - 0.7, "black", legend = "CP1", box.lty = 0)
for (i in 2:5) {
  lines(1000:2498, loadings_1000_2498_only_Thermo_Antaris_II[, i], col = i)
}

# plot(1000:2498, df_donnee_interpolee_N_BL_SG_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), - ((length(df_donnee_interpolee_N_BL_SG_1000_2498) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2498))][1, ], type = 'l', col = "blue")
# for (i in 2:508) {
#   lines(1000:2498, df_donnee_interpolee_N_BL_SG_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), - ((length(df_donnee_interpolee_N_BL_SG_1000_2498) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2498))][i, ], type = 'l', col = ifelse(i %% 2 == 0, "red", "blue"))
# }
# 
# abline(v = 1190, col = "red")
# abline(v = 1450, col = "red")
# abline(v = 1940, col = "red")
# abline(v = 2500, col = "red")
# 
# ACP_preteatment_1000_2498_no_Thermo_Antaris_II <- PCA(df_donnee_interpolee_N_BL_SG_1000_2498[, - ((length(df_donnee_interpolee_N_BL_SG_1000_2498) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2498))], ind.sup = which(as.integer(df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")) == 1), graph = FALSE)
# 
# ACP_preteatment_1000_2498_no_Thermo_Antaris_II$eig
# fviz_pca_ind(ACP_preteatment_1000_2498_no_Thermo_Antaris_II, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498[!df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_1000_2498_no_Thermo_Antaris_II, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498[!df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_1000_2498_no_Thermo_Antaris_II, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2498[!df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), ]$annee), addEllipses = TRUE, ellipse.level = 0.95)
# 
# loadings_1000_2498_no_Thermo_Antaris_II <- ACP_preteatment_1000_2498_no_Thermo_Antaris_II$var$coord
# loading_pc1_1000_2498_no_Thermo_Antaris_II <- loadings_1000_2498_no_Thermo_Antaris_II[, 1]
# 
# plot(1000:2498, loading_pc1_1000_2498_no_Thermo_Antaris_II, type = 'l', xlab = 'Longueur d\'onde', ylab = 'Loading', 
#      main = 'Loadings de la première composante principale')
# abline(v = 1190, col = "red")
# abline(v = 1450, col = "red")
# abline(v = 1940, col = "red")
# abline(v = 2500, col = "red")
```

# Vraie analyse PLS 1000 2498

```{r}
library(pls)

matrix_donnee_interpolee_N_BL_SG_1000_2498 <- as.matrix(df_donnee_interpolee_N_BL_SG_1000_2498[- ((length(df_donnee_interpolee_N_BL_SG_1000_2498) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2498))])

assign("matrix_donnee_interpolee_N_BL_SG_1000_2498_Antaris", matrix_donnee_interpolee_N_BL_SG_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), ]) # R plante si je n'utilise pas assign(), je ne sais pas pourquoi.

prot_numeric <- as.numeric(df_donnee_interpolee_N_BL_SG_1000_2498$prot)

replicate_factors <- unique(list_ech_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")])
n_segments <- 10
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")] %in% fold)
})

pls_1000_2498_IJPB_Versailles <- plsr(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")] ~ matrix_donnee_interpolee_N_BL_SG_1000_2498_IJPB_Versailles, ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2498_IJPB_Versailles)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2498_IJPB_Versailles, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = rep(c("blue", "red"), 254))
abline(0, 1, col = "red")

validationplot(pls_1000_2498_IJPB_Versailles, val.type = "RMSEP")

# Visualisation des coefficients
# coefplot(pls_1000_2498_IJPB_Versailles, ncomp = 10)

replicate_factors <- unique(spectrom_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")])
n_segments <- 100
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(spectrom_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")] %in% fold)
})

pls_1000_2498_IJPB_Versailles <- plsr(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")] ~ matrix_donnee_interpolee_N_BL_SG_1000_2498_IJPB_Versailles, ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2498_IJPB_Versailles)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2498_IJPB_Versailles, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = rep(c("blue", "red"), 254))
abline(0, 1, col = "red")

validationplot(pls_1000_2498_IJPB_Versailles, val.type = "RMSE")

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")]


predicted_values <- predict(pls_1000_2498_IJPB_Versailles, ncomp = 3)
erreurs <- abs(predicted_values - actual_values)

mean(erreurs[seq(1, length(erreurs), by = 2)])
mean(erreurs[seq(2, length(erreurs), by = 2)])
mean(erreurs[seq(1, length(erreurs), by = 2)]) / mean(erreurs[seq(2, length(erreurs), by = 2)])
```

# Etude de l'influence de la mise à l'étuve

## Interpolation 1000 2500 + prétraitement

```{r}
library(signal)
library(baseline)
library(ggplot2)

abscisse_1000_2500_Etuve = data.frame(V1 = c(1000:2500))

# Interpolation

labo_1000_2500_Etuve <- c()
list_ech_1000_2500_Etuve <- c()
spectrom_1000_2500_Etuve <- c()
list_annee_1000_2500_Etuve <- c()
list_prot_1000_2500_Etuve <- c()
    
donnee_interpolee_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 1:((length(donnee)) / 2)) {
  if (spectrom[[i]] %in% c("Thermo Antaris II", "Thermo Antaris II etuve")) {
    donnee_interpolee_1000_2500_Etuve <- c(donnee_interpolee_1000_2500_Etuve, data.frame(V2 = approx(donnee[[i * 2 - 1]], donnee[[i * 2]], xout = abscisse_1000_2500_Etuve[[1]])[[2]]))
    labo_1000_2500_Etuve <- c(labo_1000_2500_Etuve, labo[[i]])
    list_ech_1000_2500_Etuve <- c(list_ech_1000_2500_Etuve, list_ech[[i]])
    spectrom_1000_2500_Etuve <- c(spectrom_1000_2500_Etuve, spectrom[[i]])
    list_annee_1000_2500_Etuve <- c(list_annee_1000_2500_Etuve, list_annee[[i]])
    list_prot_1000_2500_Etuve <- c(list_prot_1000_2500_Etuve, list_prot[[i]])
  }
}

# Savitzky-Golay

window_sizes <- seq(5, 9, by = 2)

poly_degrees <- 2:5

errors <- matrix(0, nrow = length(window_sizes), ncol = length(poly_degrees))

calc_rmse <- function(original, smoothed) {
  sqrt(mean((original - smoothed)^2))
}

for (i in seq_along(window_sizes)) {
  window_size <- window_sizes[i]
  for (j in seq_along(poly_degrees)) {
    poly_degree <- poly_degrees[j]
    if (i >= j) {
      for (k in 2:length(donnee_interpolee_1000_2500_Etuve)) {
        smoothed_spectrum <- sgolayfilt(donnee_interpolee_1000_2500_Etuve[[k]], p = poly_degree, n = window_size)
        errors[i, j] <- errors[i, j] + calc_rmse(donnee_interpolee_1000_2500_Etuve[[k]], smoothed_spectrum)
      }
    }
  }
}

best_indices <- which(errors == min(errors), arr.ind = TRUE)
best_window_size <- window_sizes[best_indices[1]]
best_poly_degree <- poly_degrees[best_indices[2]]

print(paste("Taille de fenêtre optimale :", best_window_size))
print(paste("Degré de polynôme optimal :", best_poly_degree))

error_df <- expand.grid(WindowSize = window_sizes, PolyDegree = poly_degrees)
error_df$RMSE <- as.vector(errors)

ggplot(error_df, aes(x = WindowSize, y = PolyDegree, fill = RMSE)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(title = "Carte des erreurs RMSE pour différentes tailles de fenêtres et degrés de polynômes",
       x = "Taille de fenêtre",
       y = "Degré de polynôme") +
  theme_minimal()

donnee_interpolee_SG_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 2:length(donnee_interpolee_1000_2500_Etuve)) {
  donnee_interpolee_SG_1000_2500_Etuve <- c(donnee_interpolee_SG_1000_2500_Etuve, data.frame(V2 = sgolayfilt(donnee_interpolee_1000_2500_Etuve[[i]], p = best_poly_degree, n = best_window_size)))
}

# Detrend (Baseline)

donnee_interpolee_BL_SG_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 2:length(donnee_interpolee_SG_1000_2500_Etuve)) {
  donnee_interpolee_BL_SG_1000_2500_Etuve <- c(donnee_interpolee_BL_SG_1000_2500_Etuve, data.frame(V2 = as.vector(getCorrected(baseline(matrix(donnee_interpolee_SG_1000_2500_Etuve[[i]], nrow = 1))))))
}

# SNV (Normalisation)

donnee_interpolee_N_BL_SG_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 2:length(donnee_interpolee_BL_SG_1000_2500_Etuve)) {
  donnee_interpolee_N_BL_SG_1000_2500_Etuve <- c(donnee_interpolee_N_BL_SG_1000_2500_Etuve, data.frame(V2 = scale(donnee_interpolee_BL_SG_1000_2500_Etuve[[i]])))
}



plot(type = "l", donnee_interpolee_N_BL_SG_1000_2500_Etuve[[1]], donnee_interpolee_N_BL_SG_1000_2500_Etuve[[2]], ylim = c(- 2, 3), xlim = c(1000, 2500), col = "blue", xlab = "Longueur d'onde (nm)", ylab = "Intensité")
for (i in 3:(length(donnee_interpolee_N_BL_SG_1000_2500_Etuve))) {
  lines(donnee_interpolee_N_BL_SG_1000_2500_Etuve[[1]], donnee_interpolee_N_BL_SG_1000_2500_Etuve[[i]], col = ifelse(spectrom_1000_2500_Etuve[[i - 1]] == "Thermo Antaris II", "blue", "red"))
}
legend(950, 3, legend = c("Thermo Antaris II", "Thermo Antaris II etuve"), col = c("blue", "red"), box.lty = 0, cex = 0.7, lty = 1)
abline(v = 1190, col = "red")
abline(v = 1450, col = "red")
abline(v = 1940, col = "red")
rect(xleft = 1190 - 15, xright = 1190 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
rect(xleft = 1450 - 15, xright = 1450 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
rect(xleft = 1940 - 15, xright = 1940 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)

plot(type = "l", donnee_interpolee_1000_2500_Etuve[[1]], donnee_interpolee_1000_2500_Etuve[[2]], ylim = c(0.2, 1), xlim = c(1000, 2500), col = "blue", xlab = "Longueur d'onde (nm)", ylab = "Absorbance")
for (i in 3:((length(donnee_interpolee_1000_2500_Etuve)) / 10)) {
  lines(donnee_interpolee_1000_2500_Etuve[[1]], donnee_interpolee_1000_2500_Etuve[[i]], col = ifelse(spectrom_1000_2500_Etuve[[i - 1]] == "Thermo Antaris II", "blue", "red"))
}
abline(v = 1190, col = "red")
abline(v = 1450, col = "red")
abline(v = 1940, col = "red")
rect(xleft = 1190 - 15, xright = 1190 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
rect(xleft = 1450 - 15, xright = 1450 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
rect(xleft = 1940 - 15, xright = 1940 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)

```

## Vraie analyse ACP 1000 2500

```{r}
library(FactoMineR)
library(factoextra)
library(heplots)
library(car)

df_donnee_interpolee_N_BL_SG_1000_2500_Etuve <- data.frame(do.call(rbind, donnee_interpolee_N_BL_SG_1000_2500_Etuve))
colnames(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve) <- df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[1, ]
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve = df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[- 1, ]

df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$lab <- labo_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$ech <- list_ech_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro <- spectrom_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$annee <- list_annee_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$prot <- list_prot_1000_2500_Etuve


ACP_preteatment_1000_2500_Etuve <- PCA(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[- ((length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve))], graph = FALSE)

ACP_preteatment_1000_2500_Etuve$eig
fviz_eig(ACP_preteatment_1000_2500_Etuve, addlabels = TRUE, ylim = c(0, 70))


fviz_pca_ind(ACP_preteatment_1000_2500_Etuve, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_1000_2500_Etuve, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$annee), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_1000_2500_Etuve, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$lab), addEllipses = TRUE, ellipse.level = 0.95)

# Loadings par Longueurs d'onde

loadings_1000_2500_Etuve <- ACP_preteatment_1000_2500_Etuve$var$coord
loading_pc1_1000_2500_Etuve <- loadings_1000_2500_Etuve[, 1]

plot(1000:2500, loading_pc1_1000_2500_Etuve, type = 'l', xlab = 'Longueur d\'onde', ylab = 'Loading', lwd = 2)
abline(v = 1190, col = "red", lwd = 2)
abline(v = 1450, col = "red", lwd = 2)
abline(v = 1940, col = "red", lwd = 2)
rect(xleft = 1190 - 15, xright = 1190 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
rect(xleft = 1450 - 15, xright = 1450 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
rect(xleft = 1940 - 15, xright = 1940 + 15, ybottom = par("usr")[3], ytop = par("usr")[4], col = rgb(1, 0, 0, 1), border = NA, density = 20, angle = 45)
abline(h = 0, col = "black", lty = 3)
legend(950, - 0.7, "black", legend = "CP1", box.lty = 0)
for (i in 2:3) {
  lines(1000:2500, loadings_1000_2500_Etuve[, i], col = i)
}

fviz_pca_var(ACP_preteatment_1000_2500_Etuve, label = "none")
```

## Vraie analyse PLS 1000 2500

```{r}
library(pls)

matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve <- as.matrix(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[- ((length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve))])

assign("matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve", matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), ]) # R plante si je n'utilise pas assign(), je ne sais pas pourquoi.

prot_numeric <- as.numeric(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$prot)

replicate_factors <- unique(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")])
n_segments <- 10
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")] %in% fold)
})

pls_1000_2500_Etuve <- plsr(prot_numeric ~ matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve, ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2500_Etuve)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = ifelse(spectrom_1000_2500_Etuve == "Thermo Antaris II", "blue", "red"))
abline(0, 1, col = "red")

validationplot(pls_1000_2500_Etuve, val.type = "RMSEP")

# Visualisation des coefficients
coefplot(pls_1000_2500_Etuve, ncomp = 3)

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")]


predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
erreurs <- abs(predicted_values - actual_values)

mean(erreurs[seq(1, length(erreurs), by = 2)])
mean(erreurs[seq(2, length(erreurs), by = 2)])
mean(erreurs[seq(1, length(erreurs), by = 2)]) / mean(erreurs[seq(2, length(erreurs), by = 2)])




replicate_factors <- unique(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"])
n_segments <- 10
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"] %in% fold)
})

prot_numeric_thermo <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"]

pls_1000_2500_Etuve <- plsr(prot_numeric_thermo ~ matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II", ], ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2500_Etuve)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 4)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = "blue", ylim = c(6, 17))
abline(0, 1, col = "red")

predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 4, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve", ])
points(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"], predicted_values_bis, col = "red")

validationplot(pls_1000_2500_Etuve, val.type = "RMSEP")

# Visualisation des coefficients
coefplot(pls_1000_2500_Etuve, ncomp = 4)

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"]
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 4)
erreurs <- abs(predicted_values - actual_values)

actual_values_bis <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"]
predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 4, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve", ])
erreurs_bis <- abs(predicted_values_bis - actual_values_bis)


mean(erreurs)
mean(erreurs_bis)
mean(erreurs_bis) / mean(erreurs)

actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"]
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 4)
erreurs <- sqrt((predicted_values - actual_values)^2 / 534)

actual_values_bis <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"]
predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 4, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve", ])
erreurs_bis <- sqrt((predicted_values_bis - actual_values_bis)^2 / 255)




mean(erreurs)
mean(erreurs_bis)




replicate_factors <- unique(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"])
n_segments <- 10
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"] %in% fold)
})

prot_numeric_thermo <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"]

pls_1000_2500_Etuve <- plsr(prot_numeric_thermo ~ matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve", ], ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2500_Etuve)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = "red")
abline(0, 1, col = "red")

predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II", ])
points(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"], predicted_values_bis, col = "blue")

validationplot(pls_1000_2500_Etuve, val.type = "RMSEP")

# Visualisation des coefficients
# coefplot(pls_1000_2500_Etuve, ncomp = 10)

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"]
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
erreurs <- abs(predicted_values - actual_values)

actual_values_bis <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"]
predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II", ])
erreurs_bis <- abs(predicted_values_bis - actual_values_bis)


mean(erreurs)
mean(erreurs_bis)
mean(erreurs_bis) / mean(erreurs)

```

```{r}
list_ech_1000_2498_temp <- list_ech_1000_2498

for (i in 2879:length(list_ech_1000_2498)) {
  list_ech_1000_2498[i] <- paste0("x", list_ech_1000_2498[i])
}

replicate_factors <- unique(list_ech_1000_2498[!df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II etuve"])
n_segments <- 10
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2498[!df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II etuve"] %in% fold)
})

prot_numeric_thermo <- prot_numeric[!df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II etuve"]

pls_1000_2498 <- plsr(prot_numeric_thermo ~ matrix_donnee_interpolee_N_BL_SG_1000_2498[!df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II etuve", ], ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2498)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2498, ncomp = 3)
plot(prot_numeric[!df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II etuve"], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = "blue", ylim = c(6, 17))
abline(0, 1, col = "red")

predicted_values_bis <- predict(pls_1000_2498, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II etuve", ])
points(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II"], predicted_values_bis + 2.5, col = "red")

validationplot(pls_1000_2498, val.type = "RMSEP")

# Visualisation des coefficients
# coefplot(pls_1000_2498, ncomp = 10)

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II"]
predicted_values <- predict(pls_1000_2498, ncomp = 3)
erreurs <- abs(predicted_values - actual_values)

actual_values_bis <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II etuve"]
predicted_values_bis <- predict(pls_1000_2498, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II etuve", ])
erreurs_bis <- abs(predicted_values_bis - actual_values_bis)


mean(erreurs)
mean(erreurs_bis)
mean(erreurs_bis) / mean(erreurs)

actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II"]
predicted_values <- predict(pls_1000_2498, ncomp = 3)
erreurs <- (predicted_values - actual_values)^2 / 534

actual_values_bis <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II etuve"]
predicted_values_bis <- predict(pls_1000_2498, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2498[df_donnee_interpolee_N_BL_SG_1000_2498$spectro == "Thermo Antaris II etuve", ])
erreurs_bis <- (predicted_values_bis - actual_values_bis)^2 / 255


mean(erreurs)
mean(erreurs_bis)
mean(erreurs_bis) / mean(erreurs)
```

## Pas d'interpolation + prétraitement 

```{r}
library(signal)
library(baseline)
library(ggplot2)

abscisse_1000_2500_Etuve = data.frame(V1 = donnee[[19 * 2 - 1]])

# Interpolation

labo_1000_2500_Etuve <- c()
list_ech_1000_2500_Etuve <- c()
spectrom_1000_2500_Etuve <- c()
list_annee_1000_2500_Etuve <- c()
list_prot_1000_2500_Etuve <- c()
    
donnee_interpolee_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 1:((length(donnee)) / 2)) {
  if (labo[[i]] == "IJPB_Versailles") {
    donnee_interpolee_1000_2500_Etuve <- c(donnee_interpolee_1000_2500_Etuve, data.frame(V2 = donnee[[i * 2]]))
    labo_1000_2500_Etuve <- c(labo_1000_2500_Etuve, labo[[i]])
    list_ech_1000_2500_Etuve <- c(list_ech_1000_2500_Etuve, list_ech[[i]])
    spectrom_1000_2500_Etuve <- c(spectrom_1000_2500_Etuve, spectrom[[i]])
    list_annee_1000_2500_Etuve <- c(list_annee_1000_2500_Etuve, list_annee[[i]])
    list_prot_1000_2500_Etuve <- c(list_prot_1000_2500_Etuve, list_prot[[i]])
  }
}

# Savitzky-Golay

window_sizes <- seq(3, 13, by = 2)

poly_degrees <- 2:5

errors <- matrix(0, nrow = length(window_sizes), ncol = length(poly_degrees))

calc_rmse <- function(original, smoothed) {
  sqrt(mean((original - smoothed)^2))
}

for (i in seq_along(window_sizes)) {
  window_size <- window_sizes[i]
  for (j in seq_along(poly_degrees)) {
    poly_degree <- poly_degrees[j]
    if (i >= j) {
      for (k in 2:length(donnee_interpolee_1000_2500_Etuve)) {
        smoothed_spectrum <- sgolayfilt(donnee_interpolee_1000_2500_Etuve[[k]], p = poly_degree, n = window_size)
        errors[i, j] <- errors[i, j] + calc_rmse(donnee_interpolee_1000_2500_Etuve[[k]], smoothed_spectrum)
      }
    }
  }
}

meaning <- mean(errors) * 24 / 18

errors[1, 2] <- meaning
errors[1, 3] <- meaning
errors[1, 4] <- meaning
errors[2, 3] <- meaning
errors[2, 4] <- meaning
errors[3, 4] <- meaning

best_indices <- which(errors == min(errors), arr.ind = TRUE)
best_window_size <- window_sizes[best_indices[1]]
best_poly_degree <- poly_degrees[best_indices[2]]

print(paste("Taille de fenêtre optimale :", best_window_size))
print(paste("Degré de polynôme optimal :", best_poly_degree))

error_df <- expand.grid(WindowSize = window_sizes, PolyDegree = poly_degrees)
error_df$RMSE <- as.vector(errors)

ggplot(error_df, aes(x = WindowSize, y = PolyDegree, fill = RMSE)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(title = "Carte des erreurs RMSE pour différentes tailles de fenêtres et degrés de polynômes",
       x = "Taille de fenêtre",
       y = "Degré de polynôme") +
  theme_minimal()

donnee_interpolee_SG_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 2:length(donnee_interpolee_1000_2500_Etuve)) {
  donnee_interpolee_SG_1000_2500_Etuve <- c(donnee_interpolee_SG_1000_2500_Etuve, data.frame(V2 = sgolayfilt(donnee_interpolee_1000_2500_Etuve[[i]], p = best_poly_degree, n = best_window_size)))
}

# Detrend (Baseline)

donnee_interpolee_BL_SG_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 2:length(donnee_interpolee_SG_1000_2500_Etuve)) {
  donnee_interpolee_BL_SG_1000_2500_Etuve <- c(donnee_interpolee_BL_SG_1000_2500_Etuve, data.frame(V2 = as.vector(getCorrected(baseline(matrix(donnee_interpolee_SG_1000_2500_Etuve[[i]], nrow = 1))))))
}

# SNV (Normalisation)

donnee_interpolee_N_BL_SG_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 2:length(donnee_interpolee_BL_SG_1000_2500_Etuve)) {
  donnee_interpolee_N_BL_SG_1000_2500_Etuve <- c(donnee_interpolee_N_BL_SG_1000_2500_Etuve, data.frame(V2 = scale(donnee_interpolee_BL_SG_1000_2500_Etuve[[i]])))
}



plot(type = "l", donnee_interpolee_N_BL_SG_1000_2500_Etuve[[1]], donnee_interpolee_N_BL_SG_1000_2500_Etuve[[2]], ylim = c(- 2, 3), xlim = c(1000, 2500), col = "blue", xlab = "Longueur d'onde (nm)", ylab = "Mesure traitée du spectro en Absorbance", main = "Spectres non interpolés d'IJPB Versailles \npré-traités entre 1000 et 2498 nm")
for (i in 3:(length(donnee_interpolee_N_BL_SG_1000_2500_Etuve))) {
  lines(donnee_interpolee_N_BL_SG_1000_2500_Etuve[[1]], donnee_interpolee_N_BL_SG_1000_2500_Etuve[[i]], col = ifelse(i %% 2 == 0, "blue", "red"))
}
legend(950, 3, legend = c("Thermo Antaris II", "Thermo Antaris II etuve"), col = c("blue", "red"), box.lty = 0, cex = 0.7, lty = 1)
abline(v = 1190, col = "red")
abline(v = 1450, col = "red")
abline(v = 1940, col = "red")
abline(v = 2500, col = "red")

plot(type = "l", donnee_interpolee_1000_2500_Etuve[[1]], donnee_interpolee_1000_2500_Etuve[[2]], ylim = c(0.2, 1), xlim = c(1000, 2500), col = "blue")
for (i in 3:((length(donnee_interpolee_1000_2500_Etuve)) / 10)) {
  lines(donnee_interpolee_1000_2500_Etuve[[1]], donnee_interpolee_1000_2500_Etuve[[i]], col = ifelse(i %% 2 == 0, "blue", "red"))
}
abline(v = 1190, col = "red")
abline(v = 1450, col = "red")
abline(v = 1940, col = "red")
abline(v = 2500, col = "red")

```

## Vraie analyse ACP 1000 2500

```{r}
library(FactoMineR)
library(factoextra)
library(heplots)
library(car)

df_donnee_interpolee_N_BL_SG_1000_2500_Etuve <- data.frame(do.call(rbind, donnee_interpolee_N_BL_SG_1000_2500_Etuve))
colnames(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve) <- df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[1, ]
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve = df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[- 1, ]

df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$lab <- labo_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$ech <- list_ech_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro <- spectrom_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$annee <- list_annee_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$prot <- list_prot_1000_2500_Etuve


ACP_preteatment_1000_2500_Etuve <- PCA(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[- ((length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve))], graph = FALSE)

ACP_preteatment_1000_2500_Etuve$eig
fviz_eig(ACP_preteatment_1000_2500_Etuve, addlabels = TRUE, ylim = c(0, 60))


fviz_pca_ind(ACP_preteatment_1000_2500_Etuve, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_1000_2500_Etuve, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$annee), addEllipses = TRUE, ellipse.level = 0.95)

# Loadings par Longueurs d'onde

loadings_1000_2500_Etuve <- ACP_preteatment_1000_2500_Etuve$var$coord
loading_pc1_1000_2500_Etuve <- loadings_1000_2500_Etuve[, 1]

plot(abscisse_1000_2500_Etuve$V1, loading_pc1_1000_2500_Etuve, type = 'l', xlab = 'Longueur d\'onde', ylab = 'Loading', main = 'Loadings de la première composante principale', lwd = 2)
abline(v = 1190, col = "red")
abline(v = 1450, col = "red")
abline(v = 1940, col = "red")
abline(v = 2500, col = "red")
abline(h = 0, col = "black", lty = 3)
legend(950, - 0.7, "black", legend = "CP1", box.lty = 0)
for (i in 2:5) {
  lines(abscisse_1000_2500_Etuve$V1, loadings_1000_2500_Etuve[, i], col = i)
}

```

## Vraie analyse PLS 1000 2500

```{r}
library(pls)

matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve <- as.matrix(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[- ((length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve))])

assign("matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve", matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), ]) # R plante si je n'utilise pas assign(), je ne sais pas pourquoi.

prot_numeric <- as.numeric(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$prot)

replicate_factors <- unique(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")])
n_segments <- 10
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")] %in% fold)
})

pls_1000_2500_Etuve <- plsr(prot_numeric ~ matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve, ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2500_Etuve)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = ifelse(spectrom_1000_2500_Etuve[[i - 1]] == "Thermo Antaris II", "blue", "red"))
abline(0, 1, col = "red")

validationplot(pls_1000_2500_Etuve, val.type = "RMSEP")

# Visualisation des coefficients
coefplot(pls_1000_2500_Etuve, ncomp = 10)

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")]


predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
erreurs <- abs(predicted_values - actual_values)

mean(erreurs[seq(1, length(erreurs), by = 2)])
mean(erreurs[seq(2, length(erreurs), by = 2)])
mean(erreurs[seq(1, length(erreurs), by = 2)]) / mean(erreurs[seq(2, length(erreurs), by = 2)])




replicate_factors <- unique(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"])
n_segments <- 10
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"] %in% fold)
})

prot_numeric_thermo <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"]

pls_1000_2500_Etuve <- plsr(prot_numeric_thermo ~ matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II", ], ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2500_Etuve)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = "blue", ylim = c(6, 17))
abline(0, 1, col = "red")

predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve", ])
points(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"], predicted_values_bis, col = "red")

validationplot(pls_1000_2500_Etuve, val.type = "RMSEP")

# Visualisation des coefficients
# coefplot(pls_1000_2500_Etuve, ncomp = 10)

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"]
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
erreurs <- abs(predicted_values - actual_values)

actual_values_bis <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"]
predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve", ])
erreurs_bis <- abs(predicted_values_bis - actual_values_bis)


mean(erreurs)
mean(erreurs_bis)
mean(erreurs_bis) / mean(erreurs)





replicate_factors <- unique(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"])
n_segments <- 10
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"] %in% fold)
})

prot_numeric_thermo <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"]

pls_1000_2500_Etuve <- plsr(prot_numeric_thermo ~ matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve", ], ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2500_Etuve)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = "red")
abline(0, 1, col = "red")

predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II", ])
points(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"], predicted_values_bis, col = "blue")

validationplot(pls_1000_2500_Etuve, val.type = "RMSEP")

# Visualisation des coefficients
# coefplot(pls_1000_2500_Etuve, ncomp = 10)

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"]
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
erreurs <- abs(predicted_values - actual_values)

actual_values_bis <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"]
predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II", ])
erreurs_bis <- abs(predicted_values_bis - actual_values_bis)


mean(erreurs)
mean(erreurs_bis)
mean(erreurs_bis) / mean(erreurs)

```


## Pas d'interpolation + pas de transformation en ref/longueur d'onde + prétraitement 

```{r}
library(signal)
library(baseline)
library(ggplot2)

abscisse_1000_2500_Etuve = data.frame(V1 = Base_De_Donnees_Spectres$Annee2022$BGE1$IJPB_Versailles$`Thermo Antaris II etuve`$Mesure_1$Spectre$V1)

# Interpolation

labo_1000_2500_Etuve <- c()
list_ech_1000_2500_Etuve <- c()
spectrom_1000_2500_Etuve <- c()
list_annee_1000_2500_Etuve <- c()
list_prot_1000_2500_Etuve <- c()
    
donnee_interpolee_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)

for (i in 1:((length(donnee)) / 2)) {
  if (labo[[i]] == "IJPB_Versailles") {
    for (mesure in 1:length(Base_De_Donnees_Spectres[[ifelse(list_annee[[i]] == 2022, "Annee2022", "Annee2023")]][[list_ech[[i]]]][[labo[[i]]]][[spectrom[[i]]]])) {
      donnee_interpolee_1000_2500_Etuve <- c(donnee_interpolee_1000_2500_Etuve, data.frame(V2 = Base_De_Donnees_Spectres[[ifelse(list_annee[[i]] == 2022, "Annee2022", "Annee2023")]][[list_ech[[i]]]][[labo[[i]]]][[spectrom[[i]]]][[mesure]][["Spectre"]][["V2"]]))
      labo_1000_2500_Etuve <- c(labo_1000_2500_Etuve, labo[[i]])
      list_ech_1000_2500_Etuve <- c(list_ech_1000_2500_Etuve, list_ech[[i]])
      spectrom_1000_2500_Etuve <- c(spectrom_1000_2500_Etuve, spectrom[[i]])
      list_annee_1000_2500_Etuve <- c(list_annee_1000_2500_Etuve, list_annee[[i]])
      list_prot_1000_2500_Etuve <- c(list_prot_1000_2500_Etuve, list_prot[[i]])
    }
  }
}

# Savitzky-Golay

window_sizes <- seq(3, 13, by = 2)

poly_degrees <- 2:5

errors <- matrix(0, nrow = length(window_sizes), ncol = length(poly_degrees))

calc_rmse <- function(original, smoothed) {
  sqrt(mean((original - smoothed)^2))
}

for (i in seq_along(window_sizes)) {
  window_size <- window_sizes[i]
  for (j in seq_along(poly_degrees)) {
    poly_degree <- poly_degrees[j]
    if (i >= j) {
      for (k in 2:length(donnee_interpolee_1000_2500_Etuve)) {
        smoothed_spectrum <- sgolayfilt(donnee_interpolee_1000_2500_Etuve[[k]], p = poly_degree, n = window_size)
        errors[i, j] <- errors[i, j] + calc_rmse(donnee_interpolee_1000_2500_Etuve[[k]], smoothed_spectrum)
      }
    }
  }
}

meaning <- mean(errors) * 24 / 18

errors[1, 2] <- meaning
errors[1, 3] <- meaning
errors[1, 4] <- meaning
errors[2, 3] <- meaning
errors[2, 4] <- meaning
errors[3, 4] <- meaning

best_indices <- which(errors == min(errors), arr.ind = TRUE)
best_window_size <- window_sizes[best_indices[1]]
best_poly_degree <- poly_degrees[best_indices[2]]

print(paste("Taille de fenêtre optimale :", best_window_size))
print(paste("Degré de polynôme optimal :", best_poly_degree))

error_df <- expand.grid(WindowSize = window_sizes, PolyDegree = poly_degrees)
error_df$RMSE <- as.vector(errors)

ggplot(error_df, aes(x = WindowSize, y = PolyDegree, fill = RMSE)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(title = "Carte des erreurs RMSE pour différentes tailles de fenêtres et degrés de polynômes",
       x = "Taille de fenêtre",
       y = "Degré de polynôme") +
  theme_minimal()

donnee_interpolee_SG_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 2:length(donnee_interpolee_1000_2500_Etuve)) {
  donnee_interpolee_SG_1000_2500_Etuve <- c(donnee_interpolee_SG_1000_2500_Etuve, data.frame(V2 = sgolayfilt(donnee_interpolee_1000_2500_Etuve[[i]], p = best_poly_degree, n = best_window_size)))
}

# Detrend (Baseline)

donnee_interpolee_BL_SG_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 2:length(donnee_interpolee_SG_1000_2500_Etuve)) {
  donnee_interpolee_BL_SG_1000_2500_Etuve <- c(donnee_interpolee_BL_SG_1000_2500_Etuve, data.frame(V2 = as.vector(getCorrected(baseline(matrix(donnee_interpolee_SG_1000_2500_Etuve[[i]], nrow = 1))))))
}

# SNV (Normalisation)

donnee_interpolee_N_BL_SG_1000_2500_Etuve <- c(abscisse_1000_2500_Etuve)
for (i in 2:length(donnee_interpolee_BL_SG_1000_2500_Etuve)) {
  donnee_interpolee_N_BL_SG_1000_2500_Etuve <- c(donnee_interpolee_N_BL_SG_1000_2500_Etuve, data.frame(V2 = scale(donnee_interpolee_BL_SG_1000_2500_Etuve[[i]])))
}



plot(type = "l", donnee_interpolee_N_BL_SG_1000_2500_Etuve[[1]], donnee_interpolee_N_BL_SG_1000_2500_Etuve[[2]], ylim = c(- 2, 3), col = "blue", xlab = "Nombres d'onde (cm-1)", ylab = "Mesure traitée du spectro en Absorbance", main = "Spectres non interpolés d'IJPB Versailles \npré-traités entre 4000 et 10001 cm-1")
for (i in 3:(length(donnee_interpolee_N_BL_SG_1000_2500_Etuve))) {
  lines(donnee_interpolee_N_BL_SG_1000_2500_Etuve[[1]], donnee_interpolee_N_BL_SG_1000_2500_Etuve[[i]], col = ifelse(i %% 2 == 0, "blue", "red"))
}
abline(v = 10000000 / 1190, col = "red")
abline(v = 10000000 / 1450, col = "red")
abline(v = 10000000 / 1940, col = "red")
abline(v = 10000000 / 2500, col = "red")

plot(type = "l", donnee_interpolee_1000_2500_Etuve[[1]], donnee_interpolee_1000_2500_Etuve[[2]], ylim = c(0.2, 1), col = "blue")
for (i in 3:((length(donnee_interpolee_1000_2500_Etuve)) / 10)) {
  lines(donnee_interpolee_1000_2500_Etuve[[1]], donnee_interpolee_1000_2500_Etuve[[i]], col = ifelse(i %% 2 == 0, "blue", "red"))
}
abline(v = 10000000 / 1190, col = "red")
abline(v = 10000000 / 1450, col = "red")
abline(v = 10000000 / 1940, col = "red")
abline(v = 10000000 / 2500, col = "red")

```

## Vraie analyse ACP 1000 2500

```{r}
library(FactoMineR)
library(factoextra)
library(heplots)
library(car)

df_donnee_interpolee_N_BL_SG_1000_2500_Etuve <- data.frame(do.call(rbind, donnee_interpolee_N_BL_SG_1000_2500_Etuve))
colnames(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve) <- df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[1, ]
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve = df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[- 1, ]

df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$lab <- labo_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$ech <- list_ech_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro <- spectrom_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$annee <- list_annee_1000_2500_Etuve
df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$prot <- list_prot_1000_2500_Etuve


ACP_preteatment_1000_2500_Etuve <- PCA(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[- ((length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve))], graph = FALSE)

ACP_preteatment_1000_2500_Etuve$eig
fviz_eig(ACP_preteatment_1000_2500_Etuve, addlabels = TRUE, ylim = c(0, 60))


fviz_pca_ind(ACP_preteatment_1000_2500_Etuve, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_1000_2500_Etuve, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$annee), addEllipses = TRUE, ellipse.level = 0.95)

# Loadings par Longueurs d'onde

loadings_1000_2500_Etuve <- ACP_preteatment_1000_2500_Etuve$var$coord
loading_pc1_1000_2500_Etuve <- loadings_1000_2500_Etuve[, 1]

plot(abscisse_1000_2500_Etuve$V1, loading_pc1_1000_2500_Etuve, type = 'l', xlab = 'Longueur d\'onde', ylab = 'Loading', main = 'Loadings des premières composantes principales', lwd = 2)
abline(v = 10000000 / 1190, col = "red", lwd = 2)
abline(v = 10000000 / 1450, col = "red", lwd = 2)
abline(v = 10000000 / 1940, col = "red", lwd = 2)
abline(v = 10000000 / 2500, col = "red", lwd = 2)
abline(h = 0, col = "black", lty = 3)
legend(950, - 0.7, "black", legend = "CP1", box.lty = 0)
for (i in 2:5) {
  lines(abscisse_1000_2500_Etuve$V1, loadings_1000_2500_Etuve[, i], col = i)
}

```

## Vraie analyse PLS 1000 2500

```{r}
library(pls)

matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve <- as.matrix(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve[- ((length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve) - 4):length(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve))])

assign("matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve", matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve"), ]) # R plante si je n'utilise pas assign(), je ne sais pas pourquoi.

prot_numeric <- as.numeric(df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$prot)

list_ech_1000_2500_Etuve_temp <- list_ech_1000_2500_Etuve

for (i in 741:length(list_ech_1000_2500_Etuve)) {
  list_ech_1000_2500_Etuve[i] <- paste0("x", list_ech_1000_2500_Etuve[i])
}

replicate_factors <- unique(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"])
list_ech_1000_2500_Etuve <- list_ech_1000_2500_Etuve_temp
n_segments <- 100
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")] %in% fold)
})

pls_1000_2500_Etuve <- plsr(prot_numeric ~ matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve, ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2500_Etuve)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = rep(c("blue", "red"), 254))
abline(0, 1, col = "red")

validationplot(pls_1000_2500_Etuve, val.type = "RMSEP")

# Visualisation des coefficients
# coefplot(pls_1000_2500_Etuve, ncomp = 10)

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")]


predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
erreurs <- abs(predicted_values - actual_values)

mean(erreurs[seq(1, length(erreurs), by = 2)])
mean(erreurs[seq(2, length(erreurs), by = 2)])
mean(erreurs[seq(1, length(erreurs), by = 2)]) / mean(erreurs[seq(2, length(erreurs), by = 2)])

list_ech_1000_2500_Etuve_temp <- list_ech_1000_2500_Etuve

for (i in 741:length(list_ech_1000_2500_Etuve)) {
  list_ech_1000_2500_Etuve[i] <- paste0("x", list_ech_1000_2500_Etuve[i])
}

replicate_factors <- unique(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"])
list_ech_1000_2500_Etuve <- list_ech_1000_2500_Etuve_temp
n_segments <- 100
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"] %in% fold)
})

prot_numeric_thermo <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"]

pls_1000_2500_Etuve <- plsr(prot_numeric_thermo ~ matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II", ], ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2500_Etuve)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = "blue", ylim = c(6, 17))
abline(0, 1, col = "red")

predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve", ])
points(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"], predicted_values_bis, col = "red")

validationplot(pls_1000_2500_Etuve, val.type = "RMSEP")

# Visualisation des coefficients
# coefplot(pls_1000_2500_Etuve, ncomp = 10)

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"]
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 3)
erreurs <- abs(predicted_values - actual_values)

actual_values_bis <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"]
predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 3, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve", ])
erreurs_bis <- abs(predicted_values_bis - actual_values_bis)


mean(erreurs)
mean(erreurs_bis)
mean(erreurs_bis) / mean(erreurs)





list_ech_1000_2500_Etuve_temp <- list_ech_1000_2500_Etuve

for (i in 741:length(list_ech_1000_2500_Etuve)) {
  list_ech_1000_2500_Etuve[i] <- paste0("x", list_ech_1000_2500_Etuve[i])
}

replicate_factors <- unique(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"])
list_ech_1000_2500_Etuve <- list_ech_1000_2500_Etuve_temp
n_segments <- 100
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"] %in% fold)
})

prot_numeric_thermo <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"]

pls_1000_2500_Etuve <- plsr(prot_numeric_thermo ~ matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve", ], ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_1000_2500_Etuve)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 5)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = "red")
abline(0, 1, col = "red")

predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 5, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II", ])
points(prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"], predicted_values_bis, col = "blue")

validationplot(pls_1000_2500_Etuve, val.type = "RMSEP")

# Visualisation des coefficients
# coefplot(pls_1000_2500_Etuve, ncomp = 10)

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II etuve"]
predicted_values <- predict(pls_1000_2500_Etuve, ncomp = 5)
erreurs <- abs(predicted_values - actual_values)

actual_values_bis <- prot_numeric[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II"]
predicted_values_bis <- predict(pls_1000_2500_Etuve, ncomp = 5, newdata = matrix_donnee_interpolee_N_BL_SG_1000_2500_Etuve[df_donnee_interpolee_N_BL_SG_1000_2500_Etuve$spectro == "Thermo Antaris II", ])
erreurs_bis <- abs(predicted_values_bis - actual_values_bis)


mean(erreurs)
mean(erreurs_bis)
mean(erreurs_bis) / mean(erreurs)

```



# Interpolation 400 2500 + prétraitement

```{r}
library(signal)
library(baseline)
library(ggplot2)

abscisse_400_2498 = data.frame(V1 = c(400:2498))

# Interpolation

labo_400_2498 <- c()
list_ech_400_2498 <- c()
spectrom_400_2498 <- c()
list_annee_400_2498 <- c()
list_prot_400_2498 <- c()
    
donnee_interpolee_400_2498 <- c(abscisse_400_2498)
for (i in 1:((length(donnee)) / 2)) {
  if (max(donnee[[i * 2 - 1]]) > 2000 && min(donnee[[i * 2 - 1]]) < 500) {
    donnee_interpolee_400_2498 <- c(donnee_interpolee_400_2498, data.frame(V2 = approx(donnee[[i * 2 - 1]], donnee[[i * 2]], xout = abscisse_400_2498[[1]])[[2]]))
    labo_400_2498 <- c(labo_400_2498, labo[[i]])
    list_ech_400_2498 <- c(list_ech_400_2498, list_ech[[i]])
    spectrom_400_2498 <- c(spectrom_400_2498, spectrom[[i]])
    list_annee_400_2498 <- c(list_annee_400_2498, list_annee[[i]])
    list_prot_400_2498 <- c(list_prot_400_2498, list_prot[[i]])
  }
}

plot(type = "l", donnee_interpolee_400_2498[[1]], donnee_interpolee_400_2498[[2]], ylim = c(- 0, 1), xlim = c(400, 2498), xlab = "Longueur d'onde (nm)", ylab = "Mesure traitée du spectro en Absorbance", main = "Spectres pré-traités entre 400 et 2498 nm \navec coloration en rouge des mesures après une mise à l'étuve")
for (i in 3:(length(donnee_interpolee_400_2498))) {
  lines(donnee_interpolee_400_2498[[1]], donnee_interpolee_400_2498[[i]], col = ifelse(labo_400_2498[i - 1] == "URP3F_Lusignan", "red", i))
}

# Savitzky-Golay

# window_sizes <- seq(3, 13, by = 2)
# 
# poly_degrees <- 2:5
# 
# errors <- matrix(0, nrow = length(window_sizes), ncol = length(poly_degrees))
# 
# calc_rmse <- function(original, smoothed) {
#   sqrt(mean((original - smoothed)^2))
# }
# 
# for (i in seq_along(window_sizes)) {
#   window_size <- window_sizes[i]
#   for (j in seq_along(poly_degrees)) {
#     poly_degree <- poly_degrees[j]
#     if (i >= j) {
#       for (k in 2:length(donnee_interpolee_400_2498)) {
#         smoothed_spectrum <- sgolayfilt(donnee_interpolee_400_2498[[k]], p = poly_degree, n = window_size)
#         errors[i, j] <- errors[i, j] + calc_rmse(donnee_interpolee_400_2498[[k]], smoothed_spectrum)
#       }
#     }
#   }
# }
# 
# meaning <- mean(errors) * 24 / 18
# 
# errors[1, 2] <- meaning
# errors[1, 3] <- meaning
# errors[1, 4] <- meaning
# errors[2, 3] <- meaning
# errors[2, 4] <- meaning
# errors[3, 4] <- meaning
# 
# best_indices <- which(errors == min(errors), arr.ind = TRUE)
# best_window_size <- window_sizes[best_indices[1]]
# best_poly_degree <- poly_degrees[best_indices[2]]
# 
# print(paste("Taille de fenêtre optimale :", best_window_size))
# print(paste("Degré de polynôme optimal :", best_poly_degree))
# 
# error_df <- expand.grid(WindowSize = window_sizes, PolyDegree = poly_degrees)
# error_df$RMSE <- as.vector(errors)
# 
# # ggplot(error_df, aes(x = WindowSize, y = PolyDegree, fill = RMSE)) +
# #   geom_tile() +
# #   scale_fill_gradient(low = "white", high = "blue") +
# #   labs(title = "Carte des erreurs RMSE pour différentes tailles de fenêtres et degrés de polynômes",
# #        x = "Taille de fenêtre",
# #        y = "Degré de polynôme") +
# #   theme_minimal()
# 
# donnee_interpolee_SG_400_2498 <- c(abscisse_400_2498)
# for (i in 2:length(donnee_interpolee_400_2498)) {
#   donnee_interpolee_SG_400_2498 <- c(donnee_interpolee_SG_400_2498, data.frame(V2 = sgolayfilt(donnee_interpolee_400_2498[[i]], p = best_poly_degree, n = best_window_size)))
# }

donnee_interpolee_SG_400_2498 <- c(abscisse_400_2498)
for (i in 2:length(donnee_interpolee_400_2498)) {
  donnee_interpolee_SG_400_2498 <- c(donnee_interpolee_SG_400_2498, data.frame(V2 = sgolayfilt(donnee_interpolee_400_2498[[i]], p = 2, n = 3)))
}

# Detrend (Baseline)

donnee_interpolee_BL_SG_400_2498 <- c(abscisse_400_2498)
for (i in 2:length(donnee_interpolee_SG_400_2498)) {
  donnee_interpolee_BL_SG_400_2498 <- c(donnee_interpolee_BL_SG_400_2498, data.frame(V2 = as.vector(getCorrected(baseline(matrix(donnee_interpolee_SG_400_2498[[i]], nrow = 1))))))
}

# SNV (Normalisation)

donnee_interpolee_N_BL_SG_400_2498 <- c(abscisse_400_2498)
for (i in 2:length(donnee_interpolee_BL_SG_400_2498)) {
  donnee_interpolee_N_BL_SG_400_2498 <- c(donnee_interpolee_N_BL_SG_400_2498, data.frame(V2 = scale(donnee_interpolee_BL_SG_400_2498[[i]])))
}

plot(type = "l", donnee_interpolee_N_BL_SG_400_2498[[1]], donnee_interpolee_N_BL_SG_400_2498[[2]], ylim = c(- 2, 3), xlim = c(400, 2498), xlab = "Longueur d'onde (nm)", ylab = "Mesure traitée du spectro en Absorbance", main = "Spectres pré-traités entre 400 et 2498 nm \navec coloration en rouge des mesures après une mise à l'étuve")
for (i in 3:(length(donnee_interpolee_N_BL_SG_400_2498))) {
  lines(donnee_interpolee_N_BL_SG_400_2498[[1]], donnee_interpolee_N_BL_SG_400_2498[[i]], col = ifelse(labo_400_2498[i - 1] == "URP3F_Lusignan", "black", i))
}
```

# Vraie analyse ACP 400 2498

```{r}
library(FactoMineR)
library(factoextra)
library(heplots)
library(car)

df_donnee_interpolee_N_BL_SG_400_2498 <- data.frame(do.call(rbind, donnee_interpolee_N_BL_SG_400_2498))
colnames(df_donnee_interpolee_N_BL_SG_400_2498) <- df_donnee_interpolee_N_BL_SG_400_2498[1, ]
df_donnee_interpolee_N_BL_SG_400_2498 = df_donnee_interpolee_N_BL_SG_400_2498[- 1, ]

df_donnee_interpolee_N_BL_SG_400_2498$lab <- labo_400_2498
df_donnee_interpolee_N_BL_SG_400_2498$ech <- list_ech_400_2498
df_donnee_interpolee_N_BL_SG_400_2498$spectro <- spectrom_400_2498
df_donnee_interpolee_N_BL_SG_400_2498$annee <- list_annee_400_2498
df_donnee_interpolee_N_BL_SG_400_2498$prot <- list_prot_400_2498


ACP_preteatment_400_2498 <- PCA(df_donnee_interpolee_N_BL_SG_400_2498[- ((length(df_donnee_interpolee_N_BL_SG_400_2498) - 4):length(df_donnee_interpolee_N_BL_SG_400_2498))], graph = FALSE)

# ACP_preteatment_400_2498_no_Lusignan <- PCA(df_donnee_interpolee_N_BL_SG_400_2498[!(df_donnee_interpolee_N_BL_SG_400_2498$lab %in% c("URP3F_Lusignan")), - ((length(df_donnee_interpolee_N_BL_SG_400_2498) - 4):length(df_donnee_interpolee_N_BL_SG_400_2498))], graph = FALSE)
# 
# ACP_preteatment_400_2498_FOSS_2500 <- PCA(df_donnee_interpolee_N_BL_SG_400_2498[!(df_donnee_interpolee_N_BL_SG_400_2498$spectro %in% c("FOSS 2500")), - ((length(df_donnee_interpolee_N_BL_SG_400_2498) - 4):length(df_donnee_interpolee_N_BL_SG_400_2498))], graph = FALSE)

ACP_preteatment_400_2498$eig
fviz_eig(ACP_preteatment_400_2498, addlabels = TRUE, ylim = c(0, 50))

fviz_pca_ind(ACP_preteatment_400_2498, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498$lab), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_400_2498, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498$lab), addEllipses = FALSE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_400_2498, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498$spectro), addEllipses = TRUE, ellipse.level = 0.95)
fviz_pca_ind(ACP_preteatment_400_2498, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498$annee), addEllipses = TRUE, ellipse.level = 0.95)

fviz_pca_ind(ACP_preteatment_400_2498, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
fviz_pca_ind(ACP_preteatment_400_2498, label = "none", 
             habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))

# ACP_preteatment_400_2498_no_Lusignan$eig
# fviz_eig(ACP_preteatment_400_2498_no_Lusignan, addlabels = TRUE, ylim = c(0, 50))

# fviz_pca_ind(ACP_preteatment_400_2498_no_Lusignan, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498[!(df_donnee_interpolee_N_BL_SG_400_2498$lab %in% c("URP3F_Lusignan")), ]$lab), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_400_2498_no_Lusignan, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498[!(df_donnee_interpolee_N_BL_SG_400_2498$lab %in% c("URP3F_Lusignan")), ]$lab), addEllipses = FALSE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_400_2498_no_Lusignan, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498[!(df_donnee_interpolee_N_BL_SG_400_2498$lab %in% c("URP3F_Lusignan")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95)
# fviz_pca_ind(ACP_preteatment_400_2498_no_Lusignan, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498[!(df_donnee_interpolee_N_BL_SG_400_2498$lab %in% c("URP3F_Lusignan")), ]$annee), addEllipses = TRUE, ellipse.level = 0.95)

# fviz_pca_ind(ACP_preteatment_400_2498_no_Lusignan, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498[!(df_donnee_interpolee_N_BL_SG_400_2498$lab %in% c("URP3F_Lusignan")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(1, 3))
# fviz_pca_ind(ACP_preteatment_400_2498_no_Lusignan, label = "none", 
#              habillage = as.factor(df_donnee_interpolee_N_BL_SG_400_2498[!(df_donnee_interpolee_N_BL_SG_400_2498$lab %in% c("URP3F_Lusignan")), ]$spectro), addEllipses = TRUE, ellipse.level = 0.95, axes = c(2, 3))
# 
# ACP_preteatment_400_2498_FOSS_2500$eig
# fviz_eig(ACP_preteatment_400_2498_FOSS_2500, addlabels = TRUE, ylim = c(0, 50))
# 
# fviz_pca_ind(ACP_preteatment_400_2498_FOSS_2500, label = "none")
# 
# Significativé année avec test et effect size
# 
# scores_400_2498 <- ACP_preteatment_400_2498$ind$coord
# scores_df_400_2498 <- data.frame(scores_400_2498, Year = factor(df_donnee_interpolee_N_BL_SG_400_2498$annee))
# MANOVA_1_2_400_2498 <- manova(cbind(Dim.1, Dim.2) ~ Year, data = scores_df_400_2498)
# 
# manova_summary_1_2_400_2498 <- summary(MANOVA_1_2_400_2498, test = "Pillai")
# # sum(diag(SS_year_matrix %*% solve(SS_year_matrix + SS_residuals_matrix))) # valeur du test de Pillai
# etasq_P_1_2_400_2498 <- manova_summary_1_2_400_2498$stats[1, 2] / (manova_summary_1_2_400_2498$stats[1, 2] + 5980 - 2 - 1)
# etasq_P_1_2_400_2498 # effect size de Pillai.
# summary(MANOVA_1_2_400_2498, test = "Wilks")
# # 1 - summary(MANOVA_1_2_400_2498, test = "Wilks")$stats[1, 2] # Calcul effect size Wilks
# etasq_W <- etasq(MANOVA_1_2_400_2498, anova = TRUE)
# etasq_W[1, 1] # effect size de Wilks.
# 
# # Appliquer le test de Levene sur les scores de la première composante principale (Dim.1)
# leveneTest(Dim.1 ~ Year, data = scores_df_400_2498)
# 
# # Loadings par Longueurs d'onde
# 
# loadings_400_2498 <- ACP_preteatment_400_2498_no_Lusignan$var$coord
# loading_pc1_400_2498 <- loadings_400_2498[, 1]
# 
# plot(400:2498, loading_pc1_400_2498, type = 'l', xlab = 'Longueur d\'onde (nm)', ylab = 'Loading', 
#      main = 'Loadings des premières composantes principales \n', lwd = 2)
# 
# abline(h = 0, col = "black", lty = 3)
# legend(950, - 0.7, "black", legend = "CP1", box.lty = 0)
# for (i in 2:5) {
#   lines(400:2498, loadings_400_2498[, i], col = i)
# }
```

# Vraie analyse PLS 400 2498

```{r}
library(pls)

matrix_donnee_interpolee_N_BL_SG_400_2498 <- as.matrix(df_donnee_interpolee_N_BL_SG_400_2498[- ((length(df_donnee_interpolee_N_BL_SG_400_2498) - 4):length(df_donnee_interpolee_N_BL_SG_400_2498))])

assign("matrix_donnee_interpolee_N_BL_SG_400_2498_IJPB_Versailles", matrix_donnee_interpolee_N_BL_SG_400_2498[df_donnee_interpolee_N_BL_SG_400_2498$lab == "IJPB_Versailles", ]) # R plante si je n'utilise pas assign(), je ne sais pas pourquoi.

prot_numeric <- as.numeric(df_donnee_interpolee_N_BL_SG_400_2498$prot)

replicate_factors <- unique(list_ech_400_2498[df_donnee_interpolee_N_BL_SG_400_2498$lab == "IJPB_Versailles"])
n_segments <- 4
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(list_ech_400_2498[df_donnee_interpolee_N_BL_SG_400_2498$lab == "IJPB_Versailles"] %in% fold)
})

pls_400_2498_IJPB_Versailles <- plsr(prot_numeric[df_donnee_interpolee_N_BL_SG_400_2498$lab == "IJPB_Versailles"] ~ matrix_donnee_interpolee_N_BL_SG_400_2498_IJPB_Versailles, ncomp = 4, validation = "CV", segments = folds_indices)

explvar(pls_400_2498_IJPB_Versailles)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_400_2498_IJPB_Versailles, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_400_2498$lab == "IJPB_Versailles"], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = rep(c("blue", "red"), 254))
abline(0, 1, col = "red")

validationplot(pls_400_2498_IJPB_Versailles, val.type = "RMSEP")

# Visualisation des coefficients
# coefplot(pls_400_2498_IJPB_Versailles, ncomp = 4)

replicate_factors <- unique(spectrom_400_2498[df_donnee_interpolee_N_BL_SG_400_2498$spectro %in% c("Thermo Antaris II", "Thermo Antaris II etuve")])
n_segments <- 100
folds <- split(sample(replicate_factors), rep(1:n_segments, length.out = length(replicate_factors)))

folds_indices <- lapply(folds, function(fold) {
  which(spectrom_400_2498[df_donnee_interpolee_N_BL_SG_400_2498$lab == "IJPB_Versailles"] %in% fold)
})

pls_400_2498_IJPB_Versailles <- plsr(prot_numeric[df_donnee_interpolee_N_BL_SG_400_2498$lab == "IJPB_Versailles"] ~ matrix_donnee_interpolee_N_BL_SG_400_2498_IJPB_Versailles, ncomp = 10, validation = "CV", segments = folds_indices)

explvar(pls_400_2498_IJPB_Versailles)

# Graphique des prédictions vs valeurs réelles
predicted_values <- predict(pls_400_2498_IJPB_Versailles, ncomp = 3)
plot(prot_numeric[df_donnee_interpolee_N_BL_SG_400_2498$lab == "IJPB_Versailles"], predicted_values, 
     xlab = "Valeurs réelles", 
     ylab = "Valeurs prédites",
     main = "Prédictions PLS vs Valeurs réelles", col = rep(c("blue", "red"), 254))
abline(0, 1, col = "red")

validationplot(pls_400_2498_IJPB_Versailles, val.type = "RMSE")

# Valeurs réelles
actual_values <- prot_numeric[df_donnee_interpolee_N_BL_SG_400_2498$lab == "IJPB_Versailles"]


predicted_values <- predict(pls_400_2498_IJPB_Versailles, ncomp = 3)
erreurs <- abs(predicted_values - actual_values)

mean(erreurs[seq(1, length(erreurs), by = 2)])
mean(erreurs[seq(2, length(erreurs), by = 2)])
mean(erreurs[seq(1, length(erreurs), by = 2)]) / mean(erreurs[seq(2, length(erreurs), by = 2)])
```


```{r}
plot(Base_De_Donnees_Spectres$Annee2022$BGE1$URP3F_Lusignan$`FOSS 6500`$Mesure_1$Spectre, t = 'l', xlab = "Longueur d'onde (nm)", ylab = "Absorbance")
plot(Base_De_Donnees_Spectres$Annee2022$BGE1$`LBE Narbonne`$`Buchi NIRFlex N500`$Mesure_1$Spectre, t = 'l', xlab = "Nombre d'onde (cm-1)", ylab = "Réflectance")

plot(10000000 / Base_De_Donnees_Spectres$Annee2022$BGE1$`LBE Narbonne`$`Buchi NIRFlex N500`$Mesure_1$Spectre$V1, Base_De_Donnees_Spectres$Annee2022$BGE1$`LBE Narbonne`$`Buchi NIRFlex N500`$Mesure_1$Spectre$V2, t = 'l', xlab = "Longueur d'onde (nm)", ylab = "Réflectance")

plot(10000000 / Base_De_Donnees_Spectres$Annee2022$BGE1$`LBE Narbonne`$`Buchi NIRFlex N500`$Mesure_1$Spectre$V1, - log10(Base_De_Donnees_Spectres$Annee2022$BGE1$`LBE Narbonne`$`Buchi NIRFlex N500`$Mesure_1$Spectre$V2), t = 'l', xlab = "Longueur d'onde (nm)", ylab = "Absorbance")

plot(Base_De_Donnees_Spectres$Annee2022$BGE1$URP3F_Lusignan$`FOSS 6500`$Mesure_1$Spectre, t = 'l', xlab = "Longueur d'onde (nm)", ylab = "Absorbance")
lines(10000000 / Base_De_Donnees_Spectres$Annee2022$BGE1$`LBE Narbonne`$`Buchi NIRFlex N500`$Mesure_1$Spectre$V1, - log10(Base_De_Donnees_Spectres$Annee2022$BGE1$`LBE Narbonne`$`Buchi NIRFlex N500`$Mesure_1$Spectre$V2))
```

